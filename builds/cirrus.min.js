function renderProcess(c,d){importClass("VProcess");var e=new VProcess(theRoot),f=d.fields;e.setProcess(c);delete d.body;delete d.fields;for(var g=Object.keys(d),h=g.length;h--;)e.setVar(g[h].toUpperCase(),wApp.getType(d[g[h]]));e.exec();g=e.varToString("RESULT");""===g&&(h=e.result(),2===e.objectInfo().outputType()&&0<h.size()?g=JSON.stringify(vRegisterListToJSON(h,f)):1===e.objectInfo().outputType()&&(e=new VRegisterList(theRoot),e.setTable(h.tableInfo().idRef()),e.append(h),g=JSON.stringify(vRegisterListToJSON(e,
f))));f=["Date: "+(new Date).toGMTString(),"Content-Length: "+g.length];f=f.concat(BasicHeaders).concat(["Content-Type: text/html; charset=utf-8"]);return"HTTP/1.0 200 OK\r\n"+f.join("\r\n")+"\r\n\r\n"+g}
function renderQuery(c,d){importClass("VQuery");var e=new VQuery(theRoot),f=d.fields;e.setQuery(c);delete d.body;delete d.fields;for(var g=Object.keys(d),h=g.length;h--;)e.setVar(g[h].toUpperCase(),wApp.getType(d[g[h]]));if(e.exec())var k=JSON.stringify(vRegisterListToJSON(e.result(),f));e=["Date: "+(new Date).toGMTString(),"Content-Length: "+k.length];e=e.concat(BasicHeaders).concat(["Content-Type: application/json; charset=utf-8"]);return"HTTP/1.0 200 OK\r\n"+e.join("\r\n")+"\r\n\r\n"+k}
function vRegisterListToJSON(c,d){var e=c.tableInfo(),f=nFields2=e.fieldCount(),g=c.size(),h=[],k=[];if(void 0===d)for(;f--;)k.push({fieldName:e.fieldId(f),fieldType:e.fieldType(f)});else for(d=d.toUpperCase().split(",");f--;)-1<d.indexOf(e.fieldId(f))&&k.push({fieldName:e.fieldId(f),fieldType:e.fieldType(f)});for(f=k.length;g--;){for(var e=c.readAt(g),l=f,m={};l--;)m[k[l].fieldName]=mapField(k[l].fieldType,k[l].fieldName,e);h.push(m)}return h}
function mapField(c,d,e){switch(parseInt(c)){case 0:c=e.fieldToString(d);break;case 1:c=e.fieldToString(d);break;case 2:c=e.fieldToString(d);break;case 3:c=e.fieldToString(d);break;case 4:c=e.fieldToString(d);break;case 5:c=e.fieldToString(d);break;case 6:c=e.fieldToDouble(d);break;case 7:c=e.fieldToDate(d);break;case 8:c=e.fieldToTime(d);break;case 9:c=e.fieldToDateTime(d);break;case 10:c=e.fieldToBool(d);break;case 11:c="";break;case 12:c="";break;case 13:c="";break;case 14:c="";break;case 15:c=
"";break;case 18:c="";break;default:c=e.fieldToString(d)}return c};wApp={version:"1.3",config:{filesTable:"cirrusdat/FILES_MEM"},router:{params:{body:{}},parse_params:function(c){for(var d=c.length;d--;){var e=c[d].split("=");this.params[e[0]]=e[1].replace(/\+/g," ")}},routes:[],rexRoutes:[],addRoutes:function(c,d){if(0===Object.keys(this.routes).length||"rest"==d)for(var e=Object.keys(c),f=e.length;f--;)if("resource"==e[f].split(" ")[0]){var g=this.createREST(e[f].split(" ")[1]);this.addRoutes(g,"rest")}else{var g={},h=e[f];g[h]=c[h];h=RegExp(h.replace(/:\w+/g,
"([\\w@.]+)")+"/?$","i");this.rexRoutes.unshift(h);this.routes.unshift(g)}},createREST:function(c){var d={};d["GET /"+c]=c+"Controller#index";d["GET /"+c+"/new"]=c+"Controller#new";d["POST /"+c]=c+"Controller#create";d["GET /"+c+"/:id"]=c+"Controller#show";d["GET /"+c+"/:id/edit"]=c+"Controller#edit";d["PUT /"+c+"/:id"]=c+"Controller#update";d["DELETE /"+c+"/:id"]=c+"Controller#delete";return d},pointRequest:function(c){var d=this.rexRoutes.length;for(i=0;i<d;i++){var e=this.rexRoutes[i];if(c.match(e)){var f=
this.routes[i],g=Object.keys(f)[0],h=g.match(/:(\w+)/g);if(h)for(c=c.match(e),c.shift(),d=h.length;d--;)e=h[d],this.params[e.replace(":","")]=decodeURIComponent(c[h.indexOf(e)]);return f[g]}}return"NOT FOUND"}},session:{cookie_name:"v7App",cookie:{session:{}},session:{},flash:{},flashGet:{},flashSet:{},setFlash:function(c,d){this.changed=!0;this.flashSet[c]=d;return!0},getFlash:function(c){return this.flashGet[c]},changed:!1,set:function(c,d){this.changed=!0;this.session[c]=d;return!0},get:function(c){return this.session[c]},
setInHeader:function(){var c,d,e="";0<Object.keys(this.flashSet).length&&(this.session.flash=this.flashSet,this.flashSet={});0!==Object.keys(this.session).length&&(c=this.session.expires,d=this.session.path,delete this.session.expires,delete this.session.path,e=Base64.encode(encodeURIComponent(JSON.stringify(this.session))));e=this.cookie_name+"="+e;void 0!==c&&(e+="; expires="+c.toGMTString());void 0!==d&&(e+="; path="+d);return"set-Cookie: "+e},getFromHeader:function(c){var d={},e=wApp.cookie_name;
if(c=c.match(RegExp(wApp.session.cookie_name+"=(\\w+)\\;?")))d[e]=c[1],a=Base64.decode(d[e]),b=decodeURIComponent(a),d.session=JSON.parse(b.replace(/\0/g,"")),this.cookie=d,this.session=d.session,void 0!==this.session.flash&&(this.flashGet=this.session.flash,delete this.session.flash);return d[e]}},params:function(){return this.router.params},request:Request,response:Response,logError:logError,getHTML:getHTML,vRegisterListToJSON:vRegisterListToJSON,renderProcess:renderProcess,renderQuery:renderQuery,
mapField:mapField,getType:getType};
function http_parser(c,d){for(var e=c.split("\r\n\r\n"),f=e[0].match(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/),g=e[0].replace(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/,""),h=/(.+): (.+)/g,k=/([^&]+)=([^&]+)/g,l=f[2].split("?"),m=l[0].match(/\.(\w+)$/i),f={verb:f[1],path:f[2],protocol:f[3],url:l[0],extension:m?m[1].toLowerCase():void 0,encodeParams:l[1],decodeParams:{},headers:{},body:{},bodyDecoded:{},cookie:""};header=h.exec(g);)f.headers[header[1]]=header[2];if(g=
f.encodeParams)for(;param=k.exec(g);)f.decodeParams[param[1]]=wApp.getType(decodeURIComponent(param[2]).replace(/\+/g," "));if(2==e.length)for(g=f.body=e[1].trim().replace(/\+/g," ");body=k.exec(g);)f.bodyDecoded[body[1]]=wApp.getType(decodeURIComponent(body[2]));void 0!=f.decodeParams._method&&f.decodeParams._method.match(/^(PUT|DELETE)$/i)&&(f.verb=f.decodeParams._method.toUpperCase());return f}
function Request(c){try{var d=http_parser(c);wApp.router.params=d.decodeParams;wApp.router.params.body="application/json"===d.headers["Content-Type"]&&d.body?JSON.parse(d.body):"text/xml"===d.headers["Content-Type"]&&d.body?d.body:d.bodyDecoded;void 0!==d.headers.Cookie&&wApp.session.getFromHeader(d.headers.Cookie);return d}catch(e){return e}}
function getType(c){if(c.match(/^[1-9]\d*$/i))return parseInt(c,10);if(c.match(/^\d{1,3}(\.\d{3})*(\,\d*)?$/g))return parseFloat(c.replace(/\./g,"").replace(",","."));if(c.match(/^\d{1,3}(\,\d{3})*(\.\d*)?$/g))return parseFloat(c.replace(/\,/g,""));if(c.match(/^\d*,\d*$/i))return parseFloat(c.replace(",","."));if(c.match(/^\d*\.\d*$/i))return parseFloat(c);if(c.match(/(true|false)/))return"true"==c?!0:!1;if(c.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}$/)){var d=c.split("/"),e=c.split("-"),f=1<d.length?
d:e;return c=new Date(parseInt(f[2]),parseInt(f[1])-1,parseInt(f[0]))}if(c.match(/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/))return d=c.split("/"),e=c.split("-"),f=1<d.length?d:e,c=new Date(parseInt(f[0]),parseInt(f[1])-1,parseInt(f[2]));if(c.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w$/))return f=c.split(" "),c=f[0].split("/"),d=f[1].split(":"),f=f[2].match(/am/i)?parseInt(d[0]):parseInt(d[0])+12,c=new Date(parseInt(c[2]),parseInt(c[0])-1,parseInt(c[1]),f,parseInt(d[1]),parseInt(d[2]));
if(c.match(/^\w*, \d* \w* \d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w\w$/)){f=c.split(",")[1].split(" ");d=parseInt(f[0]);c={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}[f[1]];var f=parseInt(f[2]),g=parseInt(parmas[3].split(":")[0]),h=parseInt(parmas[3].split(":")[1]),e=parseInt(parmas[3].split(":")[2]);return c=new Date(f,c,d,g,h,e)}c.match(/^\d{2,4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{1,2}:\d{1,2}\.\d*Z$/)&&(f=c.split("T"),d=f[0],e=f[1].split(".")[0],f=parseInt(d.split("-")[0]),c=
parseInt(d.split("-")[1])-1,d=parseInt(d.split("-")[2]),g=parseInt(e.split(":")[0]),h=parseInt(e.split(":")[1]),e=parseInt(e.split(":")[2]),c=new Date(f,c,d,g,h,e));return c}var BasicHeaders=["Server: Velneo v7","transfer-coding: chunked","Keep-Alive: timeout=5, max=94","Connection: Keep-Alive"];function isAsset(c){return"js"===c.extension||"css"===c.extension}
function Response(c){try{if("SyntaxError"==c.name)throw c;if("js"===c.extension||"css"===c.extension){var d=getHTML(c.url).html;if(""!==d){var e="css"===c.url.substr(c.url.length-3)?"text/css":"application/javascript";return renderResponseAssets(d,e)}return"HTTP/1.0 404 NOT FOUND"}if("pro"===c.extension){var f=wApp.router.pointRequest(c.verb+" "+c.url);return"NOT FOUND"!=f?renderProcess(f,wApp.router.params):"HTTP/1.0 404 NOT FOUND"}if("bus"===c.extension){var g=wApp.router.pointRequest(c.verb+" "+
c.url);return"NOT FOUND"!=g?renderQuery(g,wApp.router.params):"HTTP/1.0 404 NOT FOUND"}if("OPTIONS"===c.verb)return"HTTP/1.0 204 OK\r\nAccess-Control-Allow-Origin: *\r\nAccess-Control-Allow-Headers: DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type\r\nAccess-Control-Allow-Methods: GET, POST, PUT, HEAD, OPTIONS, DELETE\r\n\r\n";var h=wApp.router.pointRequest(c.verb+" "+c.url.split(".")[0]);if("NOT FOUND"!=h){var k=h.split("#");return renderResponse(k[0],
k[1],wApp,c.extension||c.headers.Accept)}return"HTTP/1.0 404 NOT FOUND"}catch(l){switch(l.name){case "SyntaxError":return renderErrorResponse(l,"Unable to parse JSON string");default:return c=logError(l),renderErrorResponse(l,c)}}}function renderResponseAssets(c,d){var e=["Date: "+(new Date).toGMTString(),"Content-Length: "+c.length],e=e.concat(BasicHeaders).concat(["Content-Type: "+d]);return"HTTP/1.0 200 OK\r\n"+e.join("\r\n")+"\r\n\r\n"+c}
function renderResponse(c,d,e,f){void 0!==e[c].before&&(e.router.params=e[c].before(e.router.params));var g=void 0!==e.router.params.redirect_to?e.router.params:e[c][d](e.router.params);f=f||"json";g.redirect_to&&(f="redirect");f=f.match(/(html|xml|json|redirect)/i)||["json"];c=Engine[f[0]](g,e,c,d);d=["Date: "+(new Date).toGMTString(),"Content-Length: "+(c.body?c.body.length:"0")];d=d.concat(BasicHeaders).concat(c.headers);wApp.session.changed&&d.push(wApp.session.setInHeader());return c.verb+"\r\n"+
d.join("\r\n")+"\r\n\r\n"+c.body}
var Engine={json:function(c,d){var e=void 0!==c.responseCode&&void 0!==c.responseCode.code&&void 0!==c.responseCode.message?"HTTP/1.0 "+c.responseCode.code+" "+c.responseCode.message:"HTTP/1.0 200 OK";delete c.responseCode;var f=d.router.params.callback;c=f?f+"("+JSON.stringify(c)+")":JSON.stringify(c);c=unescape(encodeURIComponent(c));return{verb:e,body:c,headers:["Content-Type: application/"+(f?"javascript":"json")+"; charset=utf-8"]}},html:function(c,d,e,f){if("object"==typeof c){var g=c.layout||
"application";d="/views/"+e.replace("Controller","")+"/"+f;c.controller=e;c.action=f;!1!==c.layout?(e=getHTML("/layouts/"+g),"template"===e.type&&eval("layout_temp = "+e.template),c.session=wApp.session.session,e="template"===e.type?Handlebars.VM.template(layout_temp)(c):e.html):e="#yield";d=getHTML(d);"template"===d.type&&eval("template = "+d.template);c="template"===d.type?Handlebars.VM.template(template)(c):d.html;c=e.replace("#yield",c)}return{verb:"HTTP/1.0 200 OK",body:unescape(encodeURIComponent(c)),
headers:["Content-Type: text/html; charset=utf-8"]}},xml:function(c){return{verb:"HTTP/1.0 200 OK",body:c.xml?unescape(encodeURIComponent(c.xml)):"<?xml version='1.0' encoding='UTF-8'?><error version='1.0'>The JSON object should have an xml key</error>",headers:["Content-Type: text/xml; charset=UTF-8"]}},redirect:function(c){return{verb:"HTTP/1.0 302 Found",body:"",headers:["location: "+c.redirect_to]}}};
function getHTML(c){var d=new VRegisterList(theRoot);d.setTable(wApp.config.filesTable);d.load("PATH",[c]);if(0<d.listSize()){var e=d.readAt(0);c=e.fieldToString("BODY");d="1"==e.fieldToString("TIPO")?"html":"template";e=e.fieldToString("COMPILED")}else c="<div><h1>There is not view for this action</h1></div>",e="",d="html";return{html:c,type:d,template:e}}function logError(c){return void 0===c.lineNumber?c.message:c.message+". In Line Number: "+c.lineNumber}
function renderErrorResponse(c,d){var e=wApp.router.params.callback,f={message:d},f=e?e+"("+JSON.stringify(f)+")":JSON.stringify(f),f=unescape(encodeURIComponent(f));return"HTTP/1.0 500 INTERNAL SERVER ERROR\r\n"+BasicHeaders.join("\r\n")+"\r\n\r\n"+f}
