function renderProcess(c,d){importClass("VProcess");var e=new VProcess(theRoot),f=d.fields;e.setProcess(c);delete d.body;delete d.fields;for(var g=Object.keys(d),h=g.length;h--;)e.setVar(g[h].toUpperCase(),wApp.getType(d[g[h]]));e.exec();g=e.varToString("RESULT");""===g&&(h=e.result(),2===e.objectInfo().outputType()&&0<h.size()?g=JSON.stringify(vRegisterListToJSON(h,f)):1===e.objectInfo().outputType()&&(e=new VRegisterList(theRoot),e.setTable(h.tableInfo().idRef()),e.append(h),g=JSON.stringify(vRegisterListToJSON(e,
f))));f=["Date: "+(new Date).toGMTString(),"Content-Length: "+g.length];f=f.concat(BasicHeaders).concat(["Content-Type: text/html; charset=utf-8"]);return"HTTP/1.0 200 OK\r\n"+f.join("\r\n")+"\r\n\r\n"+g}
function renderQuery(c,d){importClass("VQuery");var e=new VQuery(theRoot),f=d.fields;e.setQuery(c);delete d.body;delete d.fields;for(var g=Object.keys(d),h=g.length;h--;)e.setVar(g[h].toUpperCase(),wApp.getType(d[g[h]]));if(e.exec())return e=JSON.stringify(vRegisterListToJSON(e.result(),f)),f=["Date: "+(new Date).toGMTString(),"Content-Length: "+e.length],f=f.concat(BasicHeaders).concat(["Content-Type: application/json; charset=utf-8"]),"HTTP/1.0 200 OK\r\n"+f.join("\r\n")+"\r\n\r\n"+e}
function vRegisterListToJSON(c,d){var e=c.tableInfo(),f=e.fieldCount(),g=c.size(),h=[],l=[],k=0;if(void 0===d)for(;f--;)k=parseInt(e.fieldType(f),10),k=11===k?parseInt("11"+e.fieldObjectType(f)):k,l.push({fieldName:e.fieldId(f),fieldType:k});else for(d="string"==typeof d?d.toUpperCase().split(","):d;f--;)-1<d.indexOf(e.fieldId(f))&&(k=parseInt(e.fieldType(f),10),k=11===k?parseInt("11"+e.fieldObjectType(f)):k,l.push({fieldName:e.fieldId(f),fieldType:k}));for(f=l.length;g--;){for(var e=c.readAt(g),
k=f,m={};k--;)m[l[k].fieldName]=mapField(l[k].fieldType,l[k].fieldName,e);h.push(m)}return h}
function mapField(c,d,e){switch(parseInt(c)){case 0:c=e.fieldToString(d);break;case 1:c=e.fieldToString(d);break;case 2:c=e.fieldToString(d);break;case 3:c=e.fieldToString(d);break;case 4:c=e.fieldToString(d);break;case 5:c=e.fieldToString(d);break;case 6:c=e.fieldToDouble(d);break;case 7:c=e.fieldToDate(d);break;case 8:c=e.fieldToDateTime(d);break;case 9:c=e.fieldToDateTime(d);break;case 10:c=e.fieldToBool(d);break;case 11:c="";break;case 111:c=e.fieldToString(d);break;case 112:c=e.fieldToString(d);
break;case 12:c="";break;case 13:c="";break;case 14:c="";break;case 15:c="";break;case 18:c="";break;default:c=e.fieldToString(d)}return c};wApp={version:"1.4",config:{filesTable:"cirrusdat/FILES_MEM",root_path:"D://cirrus"},router:{params:{body:{}},parse_params:function(c){for(var d=c.length;d--;){var e=c[d].split("=");this.params[e[0]]=e[1].replace(/\+/g," ")}},routes:[],rexRoutes:[],addRoutes:function(c){for(var d=Object.keys(c),e=d.length;e--;)if("resource"==d[e].split(" ")[0]){var f=this.createREST(d[e].split(" ")[1]);this.addRoutes(f)}else{var f={},g=d[e];f[g]=c[g];g=RegExp(g.replace(/:\w+/g,"([\\w@.]+)")+"/?$","i");this.rexRoutes.unshift(g);
this.routes.unshift(f)}},createREST:function(c){var d={};d["GET /"+c]=c+"Controller#index";d["GET /"+c+"/new"]=c+"Controller#new";d["POST /"+c]=c+"Controller#create";d["GET /"+c+"/:id"]=c+"Controller#show";d["GET /"+c+"/:id/edit"]=c+"Controller#edit";d["PUT /"+c+"/:id"]=c+"Controller#update";d["DELETE /"+c+"/:id"]=c+"Controller#delete";return d},pointRequest:function(c){var d=this.rexRoutes.length;for(i=0;i<d;i++){var e=this.rexRoutes[i];if(c.match(e)){var f=this.routes[i],g=Object.keys(f)[0],h=g.match(/:(\w+)/g);
if(h)for(c=c.match(e),c.shift(),d=h.length;d--;)e=h[d],this.params[e.replace(":","")]=decodeURIComponent(c[h.indexOf(e)]);return f[g]}}return"NOT FOUND"}},session:{cookie_name:"v7App",cookie:{session:{}},session:{},flash:{},flashGet:{},flashSet:{},setFlash:function(c,d){this.changed=!0;this.flashSet[c]=d;return!0},getFlash:function(c){return this.flashGet[c]},changed:!1,set:function(c,d){this.changed=!0;this.session[c]=d;return!0},get:function(c){return this.session[c]},setInHeader:function(){var c,
d,e="";0<Object.keys(this.flashSet).length&&(this.session.flash=this.flashSet,this.flashSet={});0!==Object.keys(this.session).length&&(c=this.session.expires,d=this.session.path,delete this.session.expires,delete this.session.path,e=Base64.encode(encodeURIComponent(JSON.stringify(this.session))));e=this.cookie_name+"="+e;void 0!==c&&(e+="; expires="+c.toGMTString());void 0!==d&&(e+="; path="+d);return"set-Cookie: "+e},getFromHeader:function(c){var d={},e=wApp.cookie_name;if(c=c.match(RegExp(wApp.session.cookie_name+
"=(\\w+)\\;?")))d[e]=c[1],a=Base64.decode(d[e]),b=decodeURIComponent(a),d.session=JSON.parse(b.replace(/\0/g,"")),this.cookie=d,this.session=d.session,void 0!==this.session.flash&&(this.flashGet=this.session.flash,delete this.session.flash,this.changed=!0);return d[e]}},params:function(){return this.router.params},responseHeaders:{headers:{},set:function(c,d){this.headers[c]=d},buildForHTTP:function(){var c=Object.keys(this.headers),d=c.length,e=[];for(z=0;z<d;z++)e.push(c[z]+": "+this.headers[c[z]]);
return e}},request:Request,response:Response,logError:logError,getHTML:getHTML,vRegisterListToJSON:vRegisterListToJSON,renderProcess:renderProcess,renderQuery:renderQuery,mapField:mapField,getType:getType};
function http_parser(c,d){for(var e=c.split("\r\n\r\n"),f=e[0].match(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/),g=e[0].replace(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/,""),h=/(.+): (.+)/g,l=/([^&]+)=([^&]+)/g,k=f[2].split("?"),m=k[0].match(/\.(\w+)$/i),f={verb:f[1],path:f[2],protocol:f[3],url:k[0],extension:m?m[1].toLowerCase():void 0,encodeParams:k[1],decodeParams:{},headers:{},body:{},bodyDecoded:{},cookie:""};header=h.exec(g);)f.headers[header[1]]=header[2];if(g=
f.encodeParams)for(;param=l.exec(g);)k=decodeURIComponent(param[1]).replace("[]",""),h=wApp.getType(decodeURIComponent(param[2]).replace(/\+/g," ")),m=f.decodeParams[k],void 0===m?f.decodeParams[k]=decodeURIComponent(param[1]).match(/^.*\[\]$/)?[h]:h:("object"!==typeof m&&(f.decodeParams[k]=[m]),f.decodeParams[k].push(h));if(2==e.length)for(g=f.body=e[1].trim().replace(/\+/g," ");body=l.exec(g);)"_method"==body[1]&&decodeURIComponent(body[2]).match(/^(PUT|DELETE)$/i)?f.verb=decodeURIComponent(body[2]).toUpperCase():
(e=decodeURIComponent(body[1]).replace("[]",""),h=f.bodyDecoded[e],k=wApp.getType(decodeURIComponent(body[2])),void 0===h?f.bodyDecoded[e]=k:("object"!=typeof h&&(f.bodyDecoded[e]=[h]),f.bodyDecoded[e].push(k)));return f}
function Request(c){try{var d=http_parser(c);wApp.router.params=d.decodeParams;void 0!==d.bodyDecoded&&(wApp.router.params.body=d.bodyDecoded);void 0!==d.headers["Content-Type"]&&d.headers["Content-Type"].match(/application\/json/i)&&d.body?wApp.router.params.body=JSON.parse(d.body):void 0!==d.headers["Content-Type"]&&d.headers["Content-Type"].match(/text\/xml/i)&&d.body?wApp.router.params.body=d.body:wApp.router.params.body=d.bodyDecoded;void 0!==d.headers.Cookie&&wApp.session.getFromHeader(d.headers.Cookie);
return d}catch(e){return e}}
function getType(c){var d,e,f,g;if(c.match(/^[1-9]\d*$/i)&&14>c.length)return parseInt(c,10);if(c.match(/^\d{1,3}(\.\d{3})*(\,\d*)?$/g))return parseFloat(c.replace(/\./g,"").replace(",","."));if(c.match(/^\d{1,3}(\,\d{3})*(\.\d*)?$/g))return parseFloat(c.replace(/\,/g,""));if(c.match(/^\d*,\d*$/i))return parseFloat(c.replace(",","."));if(c.match(/^\d*\.\d*$/i))return parseFloat(c);if(c.match(/(true|false)/))return"true"==c?!0:!1;if(c.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}$/))return d=c.split("/"),
e=c.split("-"),f=1<d.length?d:e,c=new Date(parseInt(f[2],10),parseInt(f[1],10)-1,parseInt(f[0],10));if(c.match(/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/))return d=c.split("/"),e=c.split("-"),f=1<d.length?d:e,c=new Date(parseInt(f[0],10),parseInt(f[1],10)-1,parseInt(f[2],10));if(c.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w$/))return f=c.split(" "),c=f[0].split("/"),d=f[1].split(":"),f=f[2].match(/am/i)?parseInt(d[0]):parseInt(d[0])+12,c=new Date(parseInt(c[2],10),parseInt(c[0],10)-
1,parseInt(c[1],10),f,parseInt(d[1],10),parseInt(d[2],10));if(c.match(/^\w*, \d* \w* \d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w\w$/))return f=c.split(",")[1].split(" "),d=parseInt(f[0],10),c={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}[f[1]],f=parseInt(f[2],10),hour=parseInt(parmas[3].split(":")[0],10),g=parseInt(parmas[3].split(":")[1],10),e=parseInt(parmas[3].split(":")[2],10),c=new Date(f,c,d,hour,g,e);c.match(/^\d{2,4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{1,2}:\d{1,2}\.\d*Z$/)&&
(f=c.split("T"),d=f[0],e=f[1].split(".")[0],f=parseInt(d.split("-")[0],10),c=parseInt(d.split("-")[1],10)-1,d=parseInt(d.split("-")[2],10),hour=parseInt(e.split(":")[0],10),g=parseInt(e.split(":")[1],10),e=parseInt(e.split(":")[2],10),c=new Date(f,c,d,hour,g,e));return c}var BasicHeaders=["Server: Velneo v7"];
function Response(c){try{if("SyntaxError"==c.name)throw c;var d={js:"application/javascript",css:"text/css",woff:"application/font-woff",ttf:"application/font-sfnt",svg:"image/svg+xml",eot:"application/vnd.ms-fontobject"};if(void 0!==d[c.extension]){var e=getHTML(c.url);return""!==e.html?renderResponseAssets(e,d[c.extension]):"HTTP/1.0 404 NOT FOUND"}if("pro"===c.extension){var f=wApp.router.pointRequest(c.verb+" "+c.url);return"NOT FOUND"!=f?renderProcess(f,wApp.router.params):"HTTP/1.0 404 NOT FOUND"}if("bus"===
c.extension){var g=wApp.router.pointRequest(c.verb+" "+c.url);return"NOT FOUND"!=g?renderQuery(g,wApp.router.params):"HTTP/1.0 404 NOT FOUND"}if("OPTIONS"===c.verb)return"HTTP/1.0 204 OK\r\nAccess-Control-Allow-Origin: *\r\nAccess-Control-Allow-Headers: DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type\r\nAccess-Control-Allow-Methods: GET, POST, PUT, HEAD, OPTIONS, DELETE\r\n\r\n";var h=wApp.router.pointRequest(c.verb+" "+c.url.split(".")[0]);if("NOT FOUND"!=
h){var l=h.split("#");return renderResponse(l[0],l[1],wApp,c)}var k=getHTML("/views"+c.url);if(""!==k.html){var m=getHTML("/layouts/application"),p=(""===m.html?"#yield":m.html).replace("#yield",k.html);return renderResponseAssets({html:p},"text/html; charset=utf-8")}return"HTTP/1.0 404 NOT FOUND"}catch(n){switch(n.name){case "SyntaxError":return renderErrorResponse(n,"Unable to parse JSON string");default:return c=logError(n),renderErrorResponse(n,c)}}}
function renderResponseAssets(c,d){var e=c.html,f=["Date: "+(new Date).toGMTString(),"Content-Length: "+e.length];c.useCache&&(f.push("Cache-Control: max-age="+c.maxAge),f.push("ETag: "+c.eTag));f=f.concat(BasicHeaders).concat(["Content-Type: "+d]);return"HTTP/1.0 200 OK\r\n"+f.join("\r\n")+"\r\n\r\n"+e}
function renderUnauthorized(c){var d=unescape(encodeURIComponent(JSON.stringify({message:"Unauthorized"})));return"HTTP/1.0 401 Unauthorized\r\n"+BasicHeaders.concat(['WWW-Authenticate: Basic realm="'+(c||"cirrus")+'"']).join("\r\n")+"\r\n\r\n"+d}function isAuthorized(c,d){var e=Base64.decode(d.headers.Authorization.split(" ")[1]).split(":");return c.authentication.username==e[0]&&c.authentication.password==e[1]}
function renderResponse(c,d,e,f){var g=f.extension||f.headers.Accept,h=void 0!==e[c].authentication&&"object"==typeof e[c].authentication,l=-1<((e[c].authentication||{}).actions||[]).indexOf(d)||(e[c].authentication||{}).all;if(h&&l&&(void 0===f.headers.Authorization||!1===isAuthorized(e[c],f)))return renderUnauthorized(e[c].authentication.namespace);void 0!==e[c].before&&"function"==typeof e[c].before&&(e.router.params=e[c].before(e.router.params));f=void 0!==e.router.params.redirect_to?e.router.params:
e[c][d](e.router.params);g=g||"json";f.redirect_to&&(g="redirect");g=g.match(/(html|xml|json|redirect)/i)||["json"];c=Engine[g[0]](f,e,c,d);d=["Date: "+(new Date).toGMTString(),"Content-Length: "+(c.body?c.body.length:"0")];d=d.concat(BasicHeaders).concat(c.headers).concat(e.responseHeaders.buildForHTTP());wApp.session.changed&&d.push(wApp.session.setInHeader());return c.verb+"\r\n"+d.join("\r\n")+"\r\n\r\n"+c.body}
var Engine={json:function(c,d){var e=void 0!==c.responseCode&&void 0!==c.responseCode.code&&void 0!==c.responseCode.message?"HTTP/1.0 "+c.responseCode.code+" "+c.responseCode.message:"HTTP/1.0 200 OK";delete c.responseCode;var f=d.router.params.callback;c=f?f+"("+JSON.stringify(c)+")":JSON.stringify(c);c=unescape(encodeURIComponent(c));return{verb:e,body:c,headers:["Content-Type: application/"+(f?"javascript":"json")+"; charset=utf-8"]}},html:function(c,d,e,f){if("object"==typeof c){var g=c.layout||
"application";d="/views/"+e.replace("Controller","")+"/"+f;var h;c.controller=e;c.action=f;c.session=wApp.session.session;c.flash=wApp.session.flashGet;!1!==c.layout?(e=getHTML("/layouts/"+g),"template"===e.type&&(layout_temp=Handlebars.compile(e.html)),e="template"===e.type?layout_temp(c):e.html):e="#yield";d=getHTML(d);"template"===d.type&&(h=Handlebars.compile(d.html));""===d.html&&(d.html="<div><h1>There is not view for this action</h1></div>");c="template"===d.type?h(c):d.html;c=e.replace("#yield",
c)}return{verb:"HTTP/1.0 200 OK",body:unescape(encodeURIComponent(c)),headers:["Content-Type: text/html; charset=utf-8"]}},xml:function(c){return{verb:"HTTP/1.0 200 OK",body:c.xml?unescape(encodeURIComponent(c.xml)):"<?xml version='1.0' encoding='UTF-8'?><error version='1.0'>The JSON object should have an xml key</error>",headers:["Content-Type: text/xml; charset=UTF-8"]}},redirect:function(c){return{verb:"HTTP/1.0 302 Found",body:"",headers:["location: "+c.redirect_to]}}};
function getHTML(c){importClass("VTextFile");importClass("VFile");var d=null===c.split(".")[c.split(".").length-1].match(/(css|js|html|woff|ttf|svg|eot)/i)?".html":"";c+=d;d=new VTextFile(wApp.config.root_path+c);c=new VTextFile(wApp.config.root_path+c+".hbs");var e=c.exists()?"template":"html";html=d.exists()?d.open(VFile.OpenModeReadOnly)?d.readAll():"":c.exists()?c.open(VFile.OpenModeReadOnly)?c.readAll():"":"";return{html:html,type:e}}
function logError(c){return void 0===c.lineNumber?c.message:c.message+". In Line Number: "+c.lineNumber}function renderErrorResponse(c,d){var e=wApp.router.params.callback,f={message:d},f=e?e+"("+JSON.stringify(f)+")":JSON.stringify(f),f=unescape(encodeURIComponent(f));return"HTTP/1.0 500 INTERNAL SERVER ERROR\r\n"+BasicHeaders.join("\r\n")+"\r\n\r\n"+f}
