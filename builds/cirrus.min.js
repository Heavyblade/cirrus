"use strict";function e(e,t,o){importClass("VProcess");var s=new VProcess(theRoot),a=t.fields;s.setProcess(e);var i="\r\n";delete t.body,delete t.fields;for(var d=Object.keys(t),c=d.length;c--;)d[c].toUpperCase().match(/^[A-Z0-9_]*$/)&&(t[d[c]]instanceof Date?s.setVar(d[c],t[d[c]].toISOString().split("T")[0]):s.setVar(d[c].toUpperCase(),t[d[c]]));s.exec();var l=s.varToString("RESULT"),p="Content-Type: text/html; charset=utf-8";if(""===l){var h=s.result();if(p="Content-Type: application/json",2===s.objectInfo().outputType()&&h.size()>0)l=JSON.stringify(r(h,a));else if(1===s.objectInfo().outputType()){var u=new VRegisterList(theRoot);u.setTable(h.tableInfo().idRef()),u.append(h),l=JSON.stringify(r(u,a))}}var f=["Date: "+(new Date).toGMTString(),"Content-Length: "+l.length];return"HTTP/1.0 200 OK\r\n"+(f=f.concat(n).concat([p])).join(i)+i+i+(o.isWindows()?l:unescape(encodeURIComponent(l)))}function t(e,t){importClass("VQuery");var o=new VQuery(theRoot),s=t.fields;o.setQuery(e);var a="\r\n";delete t.body,delete t.fields;for(var i=Object.keys(t),d=i.length;d--;)o.setVar(i[d].toUpperCase(),wApp.getType(t[i[d]]));if(o.exec()){var c=JSON.stringify(r(o.result(),s)),l=["Date: "+(new Date).toGMTString(),"Content-Length: "+c.length];return"HTTP/1.0 200 OK\r\n"+(l=l.concat(n).concat(["Content-Type: application/json; charset=utf-8"])).join(a)+a+a+c}}function r(e,t){var r,n=e.tableInfo(),s=n.fieldCount(),a=e.size(),i=[],d=[],c=0;if(void 0===t)for(;s--;)c=11===(r=parseInt(n.fieldType(s),10))?parseInt("11"+n.fieldObjectType(s)):r,d.push({fieldName:n.fieldId(s),fieldType:c});else for(t="string"==typeof t?t.toUpperCase().split(","):t;s--;)t.indexOf(n.fieldId(s))>-1&&(c=11===(r=parseInt(n.fieldType(s),10))?parseInt("11"+n.fieldObjectType(s)):r,d.push({fieldName:n.fieldId(s),fieldType:c}));for(s=d.length;a--;){for(var l=e.readAt(a),p=s,h={};p--;)h[d[p].fieldName]=o(d[p].fieldType,d[p].fieldName,l);i.push(h)}return i}function o(e,t,r){var o;switch(parseInt(e)){case 0:case 1:case 2:case 3:case 4:case 5:case 111:case 112:default:o=r.fieldToString(t);break;case 6:o=r.fieldToDouble(t);break;case 7:o=r.fieldToDate(t);break;case 8:case 9:o=r.fieldToDateTime(t);break;case 10:o=r.fieldToBool(t);break;case 11:case 12:case 13:case 14:case 15:case 18:o=""}return o}const n=["Server: Velneo v7","Access-Control-Allow-Origin: *","Access-Control-Allow-Headers: DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type","Access-Control-Allow-Methods: GET, POST, PUT, HEAD, OPTIONS, DELETE"];var s={version:"1.4",isWindows:function(){return theApp.sysInfo().getOsString().match(/win/i)},config:{filesTable:"cirrusdat/FILES_MEM",root_path:"D://cirrus"},router:{params:{body:{}},parse_params:function(e){for(var t=e.length;t--;){var r=e[t].split("=");this.params[r[0]]=r[1].replace(/\+/g," ")}},routes:[],rexRoutes:[],addRoutes:function(e){for(var t=Object.keys(e),r=t.length;r--;)if("resource"==t[r].split(" ")[0]){var o=this.createREST(t[r].split(" ")[1]);this.addRoutes(o)}else{var n={},s=t[r];n[s]=e[s];var a=new RegExp(s.replace(/:\w+/g,"([\\w@.]+)")+"/?$","i");this.rexRoutes.unshift(a),this.routes.unshift(n)}},createREST:function(e){var t={};return t["GET /"+e]=e+"Controller#index",t["GET /"+e+"/new"]=e+"Controller#new",t["POST /"+e]=e+"Controller#create",t["GET /"+e+"/:id"]=e+"Controller#show",t["GET /"+e+"/:id/edit"]=e+"Controller#edit",t["PUT /"+e+"/:id"]=e+"Controller#update",t["DELETE /"+e+"/:id"]=e+"Controller#delete",t},pointRequest:function(e){var t=this.rexRoutes.length;for(i=0;i<t;i++){var r=this.rexRoutes[i];if(e.match(r)){var o=this.routes[i],n=Object.keys(o)[0],s=n.match(/:(\w+)/g);if(s){var a=e.match(r);for(a.shift(),t=s.length;t--;){var d=s[t];this.params[d.replace(":","")]=decodeURIComponent(a[s.indexOf(d)])}}return o[n]}}return"NOT FOUND"}},session:{cookie_name:"v7App",cookie:{session:{}},session:{},flash:{},flashGet:{},flashSet:{},setFlash:function(e,t){return this.changed=!0,this.flashSet[e]=t,!0},getFlash:function(e){return this.flashGet[e]},changed:!1,set:function(e,t){return this.changed=!0,this.session[e]=t,!0},get:function(e){return this.session[e]},setInHeader:function(){var e,t,r="";Object.keys(this.flashSet).length>0&&(this.session.flash=this.flashSet,this.flashSet={}),0!==Object.keys(this.session).length&&(e=this.session.expires,t=this.session.path,delete this.session.expires,delete this.session.path,r=Base64.encode(encodeURIComponent(JSON.stringify(this.session))));var o=this.cookie_name+"="+r;return void 0!==e&&(o+="; expires="+e.toGMTString()),void 0!==t&&(o+="; path="+t),"set-Cookie: "+o},getFromHeader:function(e){var t=new RegExp(s.session.cookie_name+"=(\\w+)\\;?"),r={},o=s.cookie_name,n=e.match(t);return n&&(r[o]=n[1],a=Base64.decode(r[o]),b=decodeURIComponent(a),r.session=JSON.parse(b.replace(/\0/g,"")),this.cookie=r,this.session=r.session,void 0!==this.session.flash&&(this.flashGet=this.session.flash,delete this.session.flash,this.changed=!0)),r[o]}},params:function(){return this.router.params},responseHeaders:{headers:{},set:function(e,t){this.headers[e]=t},buildForHTTP:function(){var e=Object.keys(this.headers),t=e.length,r=[];for(z=0;z<t;z++)r.push(e[z]+": "+this.headers[e[z]]);return r}},request:function(e){try{var t=function(e){var t=e.split("\r\n\r\n"),r=t[0].match(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/),o=t[0].replace(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/,""),n=/(.+): (.+)/g,a=/([^&]+)=([^&]+)/g,i=r[2].split("?"),d=i[0].match(/\.(\w+)$/i),c={verb:r[1],path:r[2],protocol:r[3],url:i[0],extension:d?d[1].toLowerCase():void 0,encodeParams:i[1],decodeParams:{},headers:{},body:{},bodyDecoded:{},cookie:""};for(;header=n.exec(o);)c.headers[header[1]]=header[2];var l,p,h,u=c.encodeParams;if(c.encodeParams)for(;param=a.exec(u);)p=decodeURIComponent(param[1]).replace("[]",""),l=s.getType(decodeURIComponent(param[2]).replace(/\+/g," ")),void 0===(h=c.decodeParams[p])?c.decodeParams[p]=decodeURIComponent(param[1]).match(/^.*\[\]$/)?[l]:l:("object"!=typeof h&&(c.decodeParams[p]=[h]),c.decodeParams[p].push(l));if(2==t.length)for(u=c.body=t[1].trim().replace(/\+/g," ");body=a.exec(u);)if("_method"==body[1]&&decodeURIComponent(body[2]).match(/^(PUT|DELETE)$/i))c.verb=decodeURIComponent(body[2]).toUpperCase();else{var f=decodeURIComponent(body[1]).replace("[]",""),m=c.bodyDecoded[f],T=s.getType(decodeURIComponent(body[2]));void 0===m?c.bodyDecoded[f]=T:("object"!=typeof m&&(c.bodyDecoded[f]=[m]),c.bodyDecoded[f].push(T))}return c}(e);return s.router.params=t.decodeParams,void 0!==t.bodyDecoded&&(s.router.params.body=t.bodyDecoded),void 0!==t.headers["Content-Type"]&&t.headers["Content-Type"].match(/application\/json/i)&&t.body?s.router.params.body=JSON.parse(t.body):void 0!==t.headers["Content-Type"]&&t.headers["Content-Type"].match(/text\/xml/i)&&t.body?s.router.params.body=t.body:s.router.params.body=t.bodyDecoded,void 0!==t.headers.Cookie&&s.session.getFromHeader(t.headers.Cookie),t}catch(e){return e}},response:function(r){try{if("SyntaxError"==r.name)throw r;var o={js:"application/javascript",css:"text/css",woff:"application/font-woff",ttf:"application/font-sfnt",svg:"image/svg+xml",eot:"application/vnd.ms-fontobject"};if(void 0!==o[r.extension]){var a=l(r.url);return""!==a.html?d(a,o[r.extension],s):"HTTP/1.0 404 NOT FOUND"}if("pro"===r.extension){var i=s.router.pointRequest(r.verb+" "+r.url);return"NOT FOUND"!=i?e(i,s.router.params,s):"HTTP/1.0 404 NOT FOUND"}if("bus"===r.extension){var u=s.router.pointRequest(r.verb+" "+r.url);return"NOT FOUND"!=u?t(u,s.router.params):"HTTP/1.0 404 NOT FOUND"}if("OPTIONS"===r.verb){var f="\r\n";return"HTTP/1.0 204 OK\r\n"+["Access-Control-Allow-Origin: *","Access-Control-Allow-Headers: DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type","Access-Control-Allow-Methods: GET, POST, PUT, HEAD, OPTIONS, DELETE"].join(f)+f+f}var m=s.router.pointRequest(r.verb+" "+r.url.split(".")[0]);if("NOT FOUND"!=m){var T=m.split("#");return function(e,t,r,o){var a="\r\n",i=o.extension||o.headers.Accept,d=void 0!==r[e].authentication&&"object"==typeof r[e].authentication&&""!==r[e].authentication.username&&""!==r[e].authentication.password,l=((r[e].authentication||{}).actions||[]).indexOf(t)>-1||(r[e].authentication||{}).all;if(d&&l&&(void 0===o.headers.Authorization||!1===function(e,t){var r=Base64.decode(t.headers.Authorization.split(" ")[1]).split(":");return e.authentication.username==r[0]&&e.authentication.password==r[1]}(r[e],o)))return function(e){var t="\r\n",r=unescape(encodeURIComponent(JSON.stringify({message:"Unauthorized"}))),o=n.concat(['WWW-Authenticate: Basic realm="'+(e||"cirrus")+'"']),s="HTTP/1.0 401 Unauthorized"+t+o.join(t)+t+t+r;return s}(r[e].authentication.namespace);void 0!==r[e].before&&"function"==typeof r[e].before&&(r.router.params=r[e].before(r.router.params));var p=void 0!==r.router.params.redirect_to?r.router.params:r[e][t](r.router.params,o);i=i||"json",p.redirect_to&&(i="redirect");var h=i.match(/(html|xml|json|redirect)/i)||["json"],u=c[h[0]](p,r,e,t),f=["Date: "+(new Date).toGMTString(),"Content-Length: "+(u.body?u.body.length:"0")];f=f.concat(n).concat(u.headers).concat(r.responseHeaders.buildForHTTP()),s.session.changed&&f.push(s.session.setInHeader());var m=u.verb+a+f.join(a)+a+a+u.body;return m}(T[0],T[1],s,r)}var v=l("/views"+r.url);if(""!==v.html){var y=l("/layouts/application");return d({html:(""===y.html?"#yield":y.html).replace("#yield",v.html)},"text/html; charset=utf-8",s)}return"HTTP/1.0 404 NOT FOUND"}catch(e){return"SyntaxError"===e.name?h(e,"Unable to parse JSON string"):h(e,p(e))}},logError:p,getHTML:l,vRegisterListToJSON:r,renderProcess:e,renderQuery:t,mapField:o,getType:function(e){var t,r,o,n,s,a,i,d;if(e.match(/^[1-9]\d*$/i)&&e.length<14)return parseInt(e,10);if(e.match(/^\d{1,3}(\.\d{3})*(\,\d*)?$/g))return parseFloat(e.replace(/\./g,"").replace(",","."));if(e.match(/^\d{1,3}(\,\d{3})*(\.\d*)?$/g))return parseFloat(e.replace(/\,/g,""));if(e.match(/^\d*,\d*$/i))return parseFloat(e.replace(",","."));if(e.match(/^\d*\.\d*$/i))return parseFloat(e);if(e.match(/(true|false)/))return"true"==e;if(e.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}$/))return t=e.split("/"),r=e.split("-"),o=t.length>1?t:r,new Date(parseInt(o[2],10),parseInt(o[1],10)-1,parseInt(o[0],10));if(e.match(/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/))return t=e.split("/"),r=e.split("-"),o=t.length>1?t:r,new Date(parseInt(o[0],10),parseInt(o[1],10)-1,parseInt(o[2],10));if(e.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w$/)){var c=(o=e.split(" "))[0].split("/"),l=o[1].split(":"),p=o[2].match(/am/i)?parseInt(l[0]):parseInt(l[0])+12;return new Date(parseInt(c[2],10),parseInt(c[0],10)-1,parseInt(c[1],10),p,parseInt(l[1],10),parseInt(l[2],10))}if(e.match(/^\w*, \d* \w* \d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w\w$/)){return o=e.split(",")[1].split(" "),a=parseInt(o[0],10),s={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}[o[1]],n=parseInt(o[2],10),hour=parseInt(parmas[3].split(":")[0],10),i=parseInt(parmas[3].split(":")[1],10),d=parseInt(parmas[3].split(":")[2],10),new Date(n,s,a,hour,i,d)}if(e.match(/^\d{2,4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{1,2}:\d{1,2}\.\d*Z$/))return t=(o=e.split("T"))[0],r=o[1].split(".")[0],n=parseInt(t.split("-")[0],10),s=parseInt(t.split("-")[1],10)-1,a=parseInt(t.split("-")[2],10),hour=parseInt(r.split(":")[0],10),i=parseInt(r.split(":")[1],10),d=parseInt(r.split(":")[2],10),new Date(n,s,a,hour,i,d);return e}};function d(e,t,r){var o="\r\n",s=unescape(encodeURIComponent(e.html)),a=["Date: "+(new Date).toGMTString(),"Content-Length: "+s.length];return e.useCache&&(a.push("Cache-Control: max-age="+e.maxAge),a.push("ETag: "+e.eTag)),"HTTP/1.0 200 OK\r\n"+(a=a.concat(n).concat(["Content-Type: "+t])).join(o)+o+o+s}var c={json:function(e,t){var r=void 0!==e.responseCode&&void 0!==e.responseCode.code&&void 0!==e.responseCode.message?"HTTP/1.0 "+e.responseCode.code+" "+e.responseCode.message:"HTTP/1.0 200 OK";delete e.responseCode;var o=t.router.params.callback;return e=o?o+"("+JSON.stringify(e)+")":JSON.stringify(e),{verb:r,body:e=unescape(encodeURIComponent(e)),headers:["Content-Type: application/"+(o?"javascript":"json")+"; charset=utf-8"]}},html:function(e,t,r,o){var n,a;if("object"==typeof e){var i,d=e.layout||"application",c="/views/"+r.replace("Controller","")+"/"+o;if(e.controller=r,e.action=o,e.session=s.session.session,e.flash=s.session.flashGet,!1!==e.layout){var p=l("/layouts/"+d);"template"===p.type&&(layout_temp=Handlebars.compile(p.html)),n="template"===p.type?layout_temp(e):p.html}else n="#yield";var h=l(c);"template"===h.type&&(i=Handlebars.compile(h.html)),""===h.html&&(h.html="<div><h1>There is not view for this action</h1></div>");var u="template"===h.type?i(e):h.html;a=n.replace("#yield",u)}else a=e;return{verb:"HTTP/1.0 200 OK",body:t.isWindows()?a:unescape(encodeURIComponent(a)),headers:["Content-Type: text/html; charset=utf-8"]}},xml:function(e,t){return{verb:"HTTP/1.0 200 OK",body:e.xml?t.isWindows()?e.xml:unescape(encodeURIComponent(e.xml)):"<?xml version='1.0' encoding='UTF-8'?><error version='1.0'>The JSON object should have an xml key</error>",headers:["Content-Type: text/xml; charset=UTF-8"]}},redirect:function(e){return{verb:"HTTP/1.0 302 Found",body:"",headers:["location: "+e.redirect_to]}}};function l(e){importClass("VTextFile"),importClass("VFile");var t=null===e.split(".")[e.split(".").length-1].match(/(css|js|html|woff|ttf|svg|eot)/i)?".html":"";e+=t;var r=new VTextFile(s.config.root_path+e),o=new VTextFile(s.config.root_path+e+".hbs"),n=o.exists()?"template":"html";return r.exists()?r.open(VFile.OpenModeReadOnly)?html=r.readAll():html="":o.exists()&&o.open(VFile.OpenModeReadOnly)?html=o.readAll():html="",{html:html,type:n}}function p(e){return void 0===e.lineNumber?e.message:e.message+". In Line Number: "+e.lineNumber}function h(e,t){var r="\r\n",o=s.router.params.callback,a={message:t};return a=o?o+"("+JSON.stringify(a)+")":JSON.stringify(a),a=unescape(encodeURIComponent(a)),"HTTP/1.0 500 INTERNAL SERVER ERROR\r\n"+n.join(r)+r+r+a}module.exports=s;
