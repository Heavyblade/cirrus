function renderProcess(c,e){importClass("VProcess");var d=new VProcess(theRoot),f=e.fields;d.setProcess(c);delete e.body;delete e.fields;for(var g=Object.keys(e),h=g.length;h--;)d.setVar(g[h].toUpperCase(),wApp.getType(e[g[h]]));d.exec();g=d.varToString("RESULT");""===g&&(h=d.result(),2===d.objectInfo().outputType()&&0<h.size()?g=JSON.stringify(vRegisterListToJSON(h,f)):1===d.objectInfo().outputType()&&(d=new VRegisterList(theRoot),d.setTable(h.tableInfo().idRef()),d.append(h),g=JSON.stringify(vRegisterListToJSON(d,
f))));f=["Date: "+(new Date).toGMTString(),"Content-Length: "+g.length];f=f.concat(BasicHeaders).concat(["Content-Type: text/html; charset=utf-8"]);return"HTTP/1.0 200 OK\r\n"+f.join("\r\n")+"\r\n\r\n"+g}
function renderQuery(c,e){importClass("VQuery");var d=new VQuery(theRoot),f=e.fields;d.setQuery(c);delete e.body;delete e.fields;for(var g=Object.keys(e),h=g.length;h--;)d.setVar(g[h].toUpperCase(),wApp.getType(e[g[h]]));if(d.exec())var k=JSON.stringify(vRegisterListToJSON(d.result(),f));d=["Date: "+(new Date).toGMTString(),"Content-Length: "+k.length];d=d.concat(BasicHeaders).concat(["Content-Type: application/json; charset=utf-8"]);return"HTTP/1.0 200 OK\r\n"+d.join("\r\n")+"\r\n\r\n"+k}
function vRegisterListToJSON(c,e){var d=c.tableInfo(),f=nFields2=d.fieldCount(),g=c.size(),h=[],k=[];if(void 0===e)for(;f--;)k.push({fieldName:d.fieldId(f),fieldType:d.fieldType(f)});else for(e=e.toUpperCase().split(",");f--;)-1<e.indexOf(d.fieldId(f))&&k.push({fieldName:d.fieldId(f),fieldType:d.fieldType(f)});for(f=k.length;g--;){for(var d=c.readAt(g),l=f,m={};l--;)m[k[l].fieldName]=mapField(k[l].fieldType,k[l].fieldName,d);h.push(m)}return h}
function mapField(c,e,d){switch(parseInt(c)){case 0:c=d.fieldToString(e);break;case 1:c=d.fieldToString(e);break;case 2:c=d.fieldToString(e);break;case 3:c=d.fieldToString(e);break;case 4:c=d.fieldToString(e);break;case 5:c=d.fieldToString(e);break;case 6:c=d.fieldToDouble(e);break;case 7:c=d.fieldToDate(e);break;case 8:c=d.fieldToTime(e);break;case 9:c=d.fieldToDateTime(e);break;case 10:c=d.fieldToBool(e);break;case 11:c="";break;case 12:c="";break;case 13:c="";break;case 14:c="";break;case 15:c=
"";break;case 18:c="";break;default:c=d.fieldToString(e)}return c};wApp={version:"1.3",config:{filesTable:"cirrusdat/FILES_MEM"},router:{params:{body:{}},parse_params:function(c){for(var e=c.length;e--;){var d=c[e].split("=");this.params[d[0]]=d[1].replace(/\+/g," ")}},routes:[],rexRoutes:[],addRoutes:function(c,e){if(0===Object.keys(this.routes).length||"rest"==e)for(var d=Object.keys(c),f=d.length;f--;)if("resource"==d[f].split(" ")[0]){var g=this.createREST(d[f].split(" ")[1]);this.addRoutes(g,"rest")}else{var g={},h=d[f];g[h]=c[h];h=RegExp(h.replace(/:\w+/g,
"([\\w@.]+)")+"/?$","i");this.rexRoutes.unshift(h);this.routes.unshift(g)}},createREST:function(c){var e={};e["GET /"+c]=c+"Controller#index";e["GET /"+c+"/new"]=c+"Controller#new";e["POST /"+c]=c+"Controller#create";e["GET /"+c+"/:id"]=c+"Controller#show";e["GET /"+c+"/:id/edit"]=c+"Controller#edit";e["PUT /"+c+"/:id"]=c+"Controller#update";e["DELETE /"+c+"/:id"]=c+"Controller#delete";return e},pointRequest:function(c){var e=this.rexRoutes.length;for(i=0;i<e;i++){var d=this.rexRoutes[i];if(c.match(d)){var f=
this.routes[i],g=Object.keys(f)[0],h=g.match(/:(\w+)/g);if(h)for(c=c.match(d),c.shift(),e=h.length;e--;)d=h[e],this.params[d.replace(":","")]=decodeURIComponent(c[h.indexOf(d)]);return f[g]}}return"NOT FOUND"}},session:{cookie_name:"v7App",cookie:{session:{}},session:{},flash:{},flashGet:{},flashSet:{},setFlash:function(c,e){this.changed=!0;this.flashSet[c]=e;return!0},getFlash:function(c){return this.flashGet[c]},changed:!1,set:function(c,e){this.changed=!0;this.session[c]=e;return!0},get:function(c){return this.session[c]},
setInHeader:function(){var c,e,d="";0<Object.keys(this.flashSet).length&&(this.session.flash=this.flashSet,this.flashSet={});0!==Object.keys(this.session).length&&(c=this.session.expires,e=this.session.path,delete this.session.expires,delete this.session.path,d=Base64.encode(encodeURIComponent(JSON.stringify(this.session))));d=this.cookie_name+"="+d;void 0!==c&&(d+="; expires="+c.toGMTString());void 0!==e&&(d+="; path="+e);return"set-Cookie: "+d},getFromHeader:function(c){var e={},d=wApp.cookie_name;
if(c=c.match(RegExp(wApp.session.cookie_name+"=(\\w+)\\;?")))e[d]=c[1],a=Base64.decode(e[d]),b=decodeURIComponent(a),e.session=JSON.parse(b.replace(/\0/g,"")),this.cookie=e,this.session=e.session,void 0!==this.session.flash&&(this.flashGet=this.session.flash,delete this.session.flash,this.changed=!0);return e[d]}},params:function(){return this.router.params},request:Request,response:Response,logError:logError,getHTML:getHTML,vRegisterListToJSON:vRegisterListToJSON,renderProcess:renderProcess,renderQuery:renderQuery,
mapField:mapField,getType:getType};
function http_parser(c,e){for(var d=c.split("\r\n\r\n"),f=d[0].match(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/),g=d[0].replace(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/,""),h=/(.+): (.+)/g,k=/([^&]+)=([^&]+)/g,l=f[2].split("?"),m=l[0].match(/\.(\w+)$/i),f={verb:f[1],path:f[2],protocol:f[3],url:l[0],extension:m?m[1].toLowerCase():void 0,encodeParams:l[1],decodeParams:{},headers:{},body:{},bodyDecoded:{},cookie:""};header=h.exec(g);)f.headers[header[1]]=header[2];if(g=
f.encodeParams)for(;param=k.exec(g);)f.decodeParams[param[1]]=wApp.getType(decodeURIComponent(param[2]).replace(/\+/g," "));if(2==d.length)for(g=f.body=d[1].trim().replace(/\+/g," ");body=k.exec(g);)"_method"==body[1]&&decodeURIComponent(body[2]).match(/^(PUT|DELETE)$/i)?f.verb=decodeURIComponent(body[2]).toUpperCase():f.bodyDecoded[body[1]]=wApp.getType(decodeURIComponent(body[2]));return f}
function Request(c){try{var e=http_parser(c);wApp.router.params=e.decodeParams;wApp.router.params.body="application/json"===e.headers["Content-Type"]&&e.body?JSON.parse(e.body):"text/xml"===e.headers["Content-Type"]&&e.body?e.body:e.bodyDecoded;void 0!==e.headers.Cookie&&wApp.session.getFromHeader(e.headers.Cookie);return e}catch(d){return d}}
function getType(c){if(c.match(/^[1-9]\d*$/i)&&14>c.length)return parseInt(c,10);if(c.match(/^\d{1,3}(\.\d{3})*(\,\d*)?$/g))return parseFloat(c.replace(/\./g,"").replace(",","."));if(c.match(/^\d{1,3}(\,\d{3})*(\.\d*)?$/g))return parseFloat(c.replace(/\,/g,""));if(c.match(/^\d*,\d*$/i))return parseFloat(c.replace(",","."));if(c.match(/^\d*\.\d*$/i))return parseFloat(c);if(c.match(/(true|false)/))return"true"==c?!0:!1;if(c.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}$/)){var e=c.split("/"),d=c.split("-"),
f=1<e.length?e:d;return c=new Date(parseInt(f[2]),parseInt(f[1])-1,parseInt(f[0]))}if(c.match(/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/))return e=c.split("/"),d=c.split("-"),f=1<e.length?e:d,c=new Date(parseInt(f[0]),parseInt(f[1])-1,parseInt(f[2]));if(c.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w$/))return f=c.split(" "),c=f[0].split("/"),e=f[1].split(":"),f=f[2].match(/am/i)?parseInt(e[0]):parseInt(e[0])+12,c=new Date(parseInt(c[2]),parseInt(c[0])-1,parseInt(c[1]),f,parseInt(e[1]),
parseInt(e[2]));if(c.match(/^\w*, \d* \w* \d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w\w$/)){f=c.split(",")[1].split(" ");e=parseInt(f[0]);c={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}[f[1]];var f=parseInt(f[2]),g=parseInt(parmas[3].split(":")[0]),h=parseInt(parmas[3].split(":")[1]),d=parseInt(parmas[3].split(":")[2]);return c=new Date(f,c,e,g,h,d)}c.match(/^\d{2,4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{1,2}:\d{1,2}\.\d*Z$/)&&(f=c.split("T"),e=f[0],d=f[1].split(".")[0],f=parseInt(e.split("-")[0]),
c=parseInt(e.split("-")[1])-1,e=parseInt(e.split("-")[2]),g=parseInt(d.split(":")[0]),h=parseInt(d.split(":")[1]),d=parseInt(d.split(":")[2]),c=new Date(f,c,e,g,h,d));return c}var BasicHeaders=["Server: Velneo v7","transfer-coding: chunked","Keep-Alive: timeout=5, max=94","Connection: Keep-Alive"];function isAsset(c){return"js"===c.extension||"css"===c.extension}
function Response(c){try{if("SyntaxError"==c.name)throw c;if("js"===c.extension||"css"===c.extension){var e=getHTML(c.url);if(""!==e.html){var d="css"===c.url.substr(c.url.length-3)?"text/css":"application/javascript";return renderResponseAssets(e,d)}return"HTTP/1.0 404 NOT FOUND"}if("pro"===c.extension){var f=wApp.router.pointRequest(c.verb+" "+c.url);return"NOT FOUND"!=f?renderProcess(f,wApp.router.params):"HTTP/1.0 404 NOT FOUND"}if("bus"===c.extension){var g=wApp.router.pointRequest(c.verb+" "+
c.url);return"NOT FOUND"!=g?renderQuery(g,wApp.router.params):"HTTP/1.0 404 NOT FOUND"}if("OPTIONS"===c.verb)return"HTTP/1.0 204 OK\r\nAccess-Control-Allow-Origin: *\r\nAccess-Control-Allow-Headers: DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type\r\nAccess-Control-Allow-Methods: GET, POST, PUT, HEAD, OPTIONS, DELETE\r\n\r\n";var h=wApp.router.pointRequest(c.verb+" "+c.url.split(".")[0]);if("NOT FOUND"!=h){var k=h.split("#");return renderResponse(k[0],
k[1],wApp,c.extension||c.headers.Accept)}return"HTTP/1.0 404 NOT FOUND"}catch(l){switch(l.name){case "SyntaxError":return renderErrorResponse(l,"Unable to parse JSON string");default:return c=logError(l),renderErrorResponse(l,c)}}}
function renderResponseAssets(c,e){var d=c.html,f=["Date: "+(new Date).toGMTString(),"Content-Length: "+d.length];c.useCache&&(f.push("Cache-Control: max-age="+c.maxAge),f.push("ETag: "+c.eTag));f=f.concat(BasicHeaders).concat(["Content-Type: "+e]);return"HTTP/1.0 200 OK\r\n"+f.join("\r\n")+"\r\n\r\n"+d}
function renderResponse(c,e,d,f){void 0!==d[c].before&&(d.router.params=d[c].before(d.router.params));var g=void 0!==d.router.params.redirect_to?d.router.params:d[c][e](d.router.params);f=f||"json";g.redirect_to&&(f="redirect");f=f.match(/(html|xml|json|redirect)/i)||["json"];c=Engine[f[0]](g,d,c,e);e=["Date: "+(new Date).toGMTString(),"Content-Length: "+(c.body?c.body.length:"0")];e=e.concat(BasicHeaders).concat(c.headers);wApp.session.changed&&e.push(wApp.session.setInHeader());return c.verb+"\r\n"+
e.join("\r\n")+"\r\n\r\n"+c.body}
var Engine={json:function(c,e){var d=void 0!==c.responseCode&&void 0!==c.responseCode.code&&void 0!==c.responseCode.message?"HTTP/1.0 "+c.responseCode.code+" "+c.responseCode.message:"HTTP/1.0 200 OK";delete c.responseCode;var f=e.router.params.callback;c=f?f+"("+JSON.stringify(c)+")":JSON.stringify(c);c=unescape(encodeURIComponent(c));return{verb:d,body:c,headers:["Content-Type: application/"+(f?"javascript":"json")+"; charset=utf-8"]}},html:function(c,e,d,f){if("object"==typeof c){var g=c.layout||
"application";e="/views/"+d.replace("Controller","")+"/"+f;c.controller=d;c.action=f;c.session=wApp.session.session;c.flash=wApp.session.flashGet;!1!==c.layout?(d=getHTML("/layouts/"+g),"template"===d.type&&eval("layout_temp = "+d.template),d="template"===d.type?Handlebars.VM.template(layout_temp)(c):d.html):d="#yield";e=getHTML(e);"template"===e.type&&eval("template = "+e.template);c="template"===e.type?Handlebars.VM.template(template)(c):e.html;c=d.replace("#yield",c)}return{verb:"HTTP/1.0 200 OK",
body:unescape(encodeURIComponent(c)),headers:["Content-Type: text/html; charset=utf-8"]}},xml:function(c){return{verb:"HTTP/1.0 200 OK",body:c.xml?unescape(encodeURIComponent(c.xml)):"<?xml version='1.0' encoding='UTF-8'?><error version='1.0'>The JSON object should have an xml key</error>",headers:["Content-Type: text/xml; charset=UTF-8"]}},redirect:function(c){return{verb:"HTTP/1.0 302 Found",body:"",headers:["location: "+c.redirect_to]}}};
function getHTML(c){var e=new VRegisterList(theRoot);e.setTable(wApp.config.filesTable);e.load("PATH",[c]);if(0<e.listSize()){var d=e.readAt(0);c=d.fieldToString("BODY");var e="1"==d.fieldToString("TIPO")?"html":"template",f=d.fieldToString("COMPILED"),g=d.fieldToBool("CACHE"),h=d.fieldToInteger("MAX_AGE"),d=d.fieldToString("E_TAG")}else c="<div><h1>There is not view for this action</h1></div>",f="",e="html",g=!1,h=0,d="";return{html:c,type:e,template:f,useCache:g,maxAge:h,eTag:d}}
function logError(c){return void 0===c.lineNumber?c.message:c.message+". In Line Number: "+c.lineNumber}function renderErrorResponse(c,e){var d=wApp.router.params.callback,f={message:e},f=d?d+"("+JSON.stringify(f)+")":JSON.stringify(f),f=unescape(encodeURIComponent(f));return"HTTP/1.0 500 INTERNAL SERVER ERROR\r\n"+BasicHeaders.join("\r\n")+"\r\n\r\n"+f}
