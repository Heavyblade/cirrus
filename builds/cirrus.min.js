function renderProcess(c,e){importClass("VProcess");var d=new VProcess(theRoot),f=e.fields;d.setProcess(c);delete e.body;delete e.fields;for(var g=Object.keys(e),h=g.length;h--;)g[h].toUpperCase().match(/^[A-Z0-9_]*$/)&&(e[g[h]]instanceof Date?d.setVar(g[h],e[g[h]].toISOString().split("T")[0]):d.setVar(g[h].toUpperCase(),e[g[h]]));d.exec();g=d.varToString("RESULT");""===g&&(h=d.result(),2===d.objectInfo().outputType()&&0<h.size()?g=JSON.stringify(vRegisterListToJSON(h,f)):1===d.objectInfo().outputType()&&
(d=new VRegisterList(theRoot),d.setTable(h.tableInfo().idRef()),d.append(h),g=JSON.stringify(vRegisterListToJSON(d,f))));f=["Date: "+(new Date).toGMTString(),"Content-Length: "+g.length];f=f.concat(BasicHeaders).concat(["Content-Type: text/html; charset=utf-8"]);return"HTTP/1.0 200 OK\r\n"+f.join("\r\n")+"\r\n\r\n"+g}
function renderQuery(c,e){importClass("VQuery");var d=new VQuery(theRoot),f=e.fields;d.setQuery(c);delete e.body;delete e.fields;for(var g=Object.keys(e),h=g.length;h--;)d.setVar(g[h].toUpperCase(),wApp.getType(e[g[h]]));if(d.exec())return d=JSON.stringify(vRegisterListToJSON(d.result(),f)),f=["Date: "+(new Date).toGMTString(),"Content-Length: "+d.length],f=f.concat(BasicHeaders).concat(["Content-Type: application/json; charset=utf-8"]),"HTTP/1.0 200 OK\r\n"+f.join("\r\n")+"\r\n\r\n"+d}
function vRegisterListToJSON(c,e){var d=c.tableInfo(),f=d.fieldCount(),g=c.size(),h=[],l=[],k=0;if(void 0===e)for(;f--;)k=parseInt(d.fieldType(f),10),k=11===k?parseInt("11"+d.fieldObjectType(f)):k,l.push({fieldName:d.fieldId(f),fieldType:k});else for(e="string"==typeof e?e.toUpperCase().split(","):e;f--;)-1<e.indexOf(d.fieldId(f))&&(k=parseInt(d.fieldType(f),10),k=11===k?parseInt("11"+d.fieldObjectType(f)):k,l.push({fieldName:d.fieldId(f),fieldType:k}));for(f=l.length;g--;){for(var d=c.readAt(g),
k=f,m={};k--;)m[l[k].fieldName]=mapField(l[k].fieldType,l[k].fieldName,d);h.push(m)}return h}
function mapField(c,e,d){switch(parseInt(c)){case 0:c=d.fieldToString(e);break;case 1:c=d.fieldToString(e);break;case 2:c=d.fieldToString(e);break;case 3:c=d.fieldToString(e);break;case 4:c=d.fieldToString(e);break;case 5:c=d.fieldToString(e);break;case 6:c=d.fieldToDouble(e);break;case 7:c=d.fieldToDate(e);break;case 8:c=d.fieldToDateTime(e);break;case 9:c=d.fieldToDateTime(e);break;case 10:c=d.fieldToBool(e);break;case 11:c="";break;case 111:c=d.fieldToString(e);break;case 112:c=d.fieldToString(e);
break;case 12:c="";break;case 13:c="";break;case 14:c="";break;case 15:c="";break;case 18:c="";break;default:c=d.fieldToString(e)}return c};wApp={version:"1.4",isWindows:function(){return theApp.sysInfo().getOsString().match(/win/i)},config:{filesTable:"cirrusdat/FILES_MEM",root_path:"D://cirrus"},router:{params:{body:{}},parse_params:function(c){for(var e=c.length;e--;){var d=c[e].split("=");this.params[d[0]]=d[1].replace(/\+/g," ")}},routes:[],rexRoutes:[],addRoutes:function(c){for(var e=Object.keys(c),d=e.length;d--;)if("resource"==e[d].split(" ")[0]){var f=this.createREST(e[d].split(" ")[1]);this.addRoutes(f)}else{var f={},g=e[d];
f[g]=c[g];g=RegExp(g.replace(/:\w+/g,"([\\w@.]+)")+"/?$","i");this.rexRoutes.unshift(g);this.routes.unshift(f)}},createREST:function(c){var e={};e["GET /"+c]=c+"Controller#index";e["GET /"+c+"/new"]=c+"Controller#new";e["POST /"+c]=c+"Controller#create";e["GET /"+c+"/:id"]=c+"Controller#show";e["GET /"+c+"/:id/edit"]=c+"Controller#edit";e["PUT /"+c+"/:id"]=c+"Controller#update";e["DELETE /"+c+"/:id"]=c+"Controller#delete";return e},pointRequest:function(c){var e=this.rexRoutes.length;for(i=0;i<e;i++){var d=
this.rexRoutes[i];if(c.match(d)){var f=this.routes[i],g=Object.keys(f)[0],h=g.match(/:(\w+)/g);if(h)for(c=c.match(d),c.shift(),e=h.length;e--;)d=h[e],this.params[d.replace(":","")]=decodeURIComponent(c[h.indexOf(d)]);return f[g]}}return"NOT FOUND"}},session:{cookie_name:"v7App",cookie:{session:{}},session:{},flash:{},flashGet:{},flashSet:{},setFlash:function(c,e){this.changed=!0;this.flashSet[c]=e;return!0},getFlash:function(c){return this.flashGet[c]},changed:!1,set:function(c,e){this.changed=!0;
this.session[c]=e;return!0},get:function(c){return this.session[c]},setInHeader:function(){var c,e,d="";0<Object.keys(this.flashSet).length&&(this.session.flash=this.flashSet,this.flashSet={});0!==Object.keys(this.session).length&&(c=this.session.expires,e=this.session.path,delete this.session.expires,delete this.session.path,d=Base64.encode(encodeURIComponent(JSON.stringify(this.session))));d=this.cookie_name+"="+d;void 0!==c&&(d+="; expires="+c.toGMTString());void 0!==e&&(d+="; path="+e);return"set-Cookie: "+
d},getFromHeader:function(c){var e={},d=wApp.cookie_name;if(c=c.match(RegExp(wApp.session.cookie_name+"=(\\w+)\\;?")))e[d]=c[1],a=Base64.decode(e[d]),b=decodeURIComponent(a),e.session=JSON.parse(b.replace(/\0/g,"")),this.cookie=e,this.session=e.session,void 0!==this.session.flash&&(this.flashGet=this.session.flash,delete this.session.flash,this.changed=!0);return e[d]}},params:function(){return this.router.params},responseHeaders:{headers:{},set:function(c,e){this.headers[c]=e},buildForHTTP:function(){var c=
Object.keys(this.headers),e=c.length,d=[];for(z=0;z<e;z++)d.push(c[z]+": "+this.headers[c[z]]);return d}},request:Request,response:Response,logError:logError,getHTML:getHTML,vRegisterListToJSON:vRegisterListToJSON,renderProcess:renderProcess,renderQuery:renderQuery,mapField:mapField,getType:getType};
function http_parser(c,e){for(var d=c.split("\r\n\r\n"),f=d[0].match(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/),g=d[0].replace(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/,""),h=/(.+): (.+)/g,l=/([^&]+)=([^&]+)/g,k=f[2].split("?"),m=k[0].match(/\.(\w+)$/i),f={verb:f[1],path:f[2],protocol:f[3],url:k[0],extension:m?m[1].toLowerCase():void 0,encodeParams:k[1],decodeParams:{},headers:{},body:{},bodyDecoded:{},cookie:""};header=h.exec(g);)f.headers[header[1]]=header[2];if(g=
f.encodeParams)for(;param=l.exec(g);)k=decodeURIComponent(param[1]).replace("[]",""),h=wApp.getType(decodeURIComponent(param[2]).replace(/\+/g," ")),m=f.decodeParams[k],void 0===m?f.decodeParams[k]=decodeURIComponent(param[1]).match(/^.*\[\]$/)?[h]:h:("object"!==typeof m&&(f.decodeParams[k]=[m]),f.decodeParams[k].push(h));if(2==d.length)for(g=f.body=d[1].trim().replace(/\+/g," ");body=l.exec(g);)"_method"==body[1]&&decodeURIComponent(body[2]).match(/^(PUT|DELETE)$/i)?f.verb=decodeURIComponent(body[2]).toUpperCase():
(d=decodeURIComponent(body[1]).replace("[]",""),h=f.bodyDecoded[d],k=wApp.getType(decodeURIComponent(body[2])),void 0===h?f.bodyDecoded[d]=k:("object"!=typeof h&&(f.bodyDecoded[d]=[h]),f.bodyDecoded[d].push(k)));return f}
function Request(c){try{var e=http_parser(c);wApp.router.params=e.decodeParams;void 0!==e.bodyDecoded&&(wApp.router.params.body=e.bodyDecoded);void 0!==e.headers["Content-Type"]&&e.headers["Content-Type"].match(/application\/json/i)&&e.body?wApp.router.params.body=JSON.parse(e.body):void 0!==e.headers["Content-Type"]&&e.headers["Content-Type"].match(/text\/xml/i)&&e.body?wApp.router.params.body=e.body:wApp.router.params.body=e.bodyDecoded;void 0!==e.headers.Cookie&&wApp.session.getFromHeader(e.headers.Cookie);
return e}catch(d){return d}}
function getType(c){var e,d,f,g;if(c.match(/^[1-9]\d*$/i)&&14>c.length)return parseInt(c,10);if(c.match(/^\d{1,3}(\.\d{3})*(\,\d*)?$/g))return parseFloat(c.replace(/\./g,"").replace(",","."));if(c.match(/^\d{1,3}(\,\d{3})*(\.\d*)?$/g))return parseFloat(c.replace(/\,/g,""));if(c.match(/^\d*,\d*$/i))return parseFloat(c.replace(",","."));if(c.match(/^\d*\.\d*$/i))return parseFloat(c);if(c.match(/(true|false)/))return"true"==c?!0:!1;if(c.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}$/))return e=c.split("/"),
d=c.split("-"),f=1<e.length?e:d,c=new Date(parseInt(f[2],10),parseInt(f[1],10)-1,parseInt(f[0],10));if(c.match(/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/))return e=c.split("/"),d=c.split("-"),f=1<e.length?e:d,c=new Date(parseInt(f[0],10),parseInt(f[1],10)-1,parseInt(f[2],10));if(c.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w$/))return f=c.split(" "),c=f[0].split("/"),e=f[1].split(":"),f=f[2].match(/am/i)?parseInt(e[0]):parseInt(e[0])+12,c=new Date(parseInt(c[2],10),parseInt(c[0],10)-
1,parseInt(c[1],10),f,parseInt(e[1],10),parseInt(e[2],10));if(c.match(/^\w*, \d* \w* \d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w\w$/))return f=c.split(",")[1].split(" "),e=parseInt(f[0],10),c={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}[f[1]],f=parseInt(f[2],10),hour=parseInt(parmas[3].split(":")[0],10),g=parseInt(parmas[3].split(":")[1],10),d=parseInt(parmas[3].split(":")[2],10),c=new Date(f,c,e,hour,g,d);c.match(/^\d{2,4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{1,2}:\d{1,2}\.\d*Z$/)&&
(f=c.split("T"),e=f[0],d=f[1].split(".")[0],f=parseInt(e.split("-")[0],10),c=parseInt(e.split("-")[1],10)-1,e=parseInt(e.split("-")[2],10),hour=parseInt(d.split(":")[0],10),g=parseInt(d.split(":")[1],10),d=parseInt(d.split(":")[2],10),c=new Date(f,c,e,hour,g,d));return c}var BasicHeaders=["Server: Velneo v7"];
function Response(c){try{if("SyntaxError"==c.name)throw c;var e={js:"application/javascript",css:"text/css",woff:"application/font-woff",ttf:"application/font-sfnt",svg:"image/svg+xml",eot:"application/vnd.ms-fontobject"};if(void 0!==e[c.extension]){var d=getHTML(c.url);return""!==d.html?renderResponseAssets(d,e[c.extension],wApp):"HTTP/1.0 404 NOT FOUND"}if("pro"===c.extension){var f=wApp.router.pointRequest(c.verb+" "+c.url);return"NOT FOUND"!=f?renderProcess(f,wApp.router.params):"HTTP/1.0 404 NOT FOUND"}if("bus"===
c.extension){var g=wApp.router.pointRequest(c.verb+" "+c.url);return"NOT FOUND"!=g?renderQuery(g,wApp.router.params):"HTTP/1.0 404 NOT FOUND"}if("OPTIONS"===c.verb)return"HTTP/1.0 204 OK\r\nAccess-Control-Allow-Origin: *\r\nAccess-Control-Allow-Headers: DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type\r\nAccess-Control-Allow-Methods: GET, POST, PUT, HEAD, OPTIONS, DELETE\r\n\r\n";var h=wApp.router.pointRequest(c.verb+" "+c.url.split(".")[0]);if("NOT FOUND"!=
h){var l=h.split("#");return renderResponse(l[0],l[1],wApp,c)}var k=getHTML("/views"+c.url);if(""!==k.html){var m=getHTML("/layouts/application"),p=(""===m.html?"#yield":m.html).replace("#yield",k.html);return renderResponseAssets({html:p},"text/html; charset=utf-8",wApp)}return"HTTP/1.0 404 NOT FOUND"}catch(n){switch(n.name){case "SyntaxError":return renderErrorResponse(n,"Unable to parse JSON string");default:return c=logError(n),renderErrorResponse(n,c)}}}
function renderResponseAssets(c,e,d){d=unescape(encodeURIComponent(c.html));var f=["Date: "+(new Date).toGMTString(),"Content-Length: "+d.length];c.useCache&&(f.push("Cache-Control: max-age="+c.maxAge),f.push("ETag: "+c.eTag));f=f.concat(BasicHeaders).concat(["Content-Type: "+e]);return"HTTP/1.0 200 OK\r\n"+f.join("\r\n")+"\r\n\r\n"+d}
function renderUnauthorized(c){var e=unescape(encodeURIComponent(JSON.stringify({message:"Unauthorized"})));return"HTTP/1.0 401 Unauthorized\r\n"+BasicHeaders.concat(['WWW-Authenticate: Basic realm="'+(c||"cirrus")+'"']).join("\r\n")+"\r\n\r\n"+e}function isAuthorized(c,e){var d=Base64.decode(e.headers.Authorization.split(" ")[1]).split(":");return c.authentication.username==d[0]&&c.authentication.password==d[1]}
function renderResponse(c,e,d,f){var g=f.extension||f.headers.Accept,h=void 0!==d[c].authentication&&"object"==typeof d[c].authentication&&""!==d[c].authentication.username&&""!==d[c].authentication.password,l=-1<((d[c].authentication||{}).actions||[]).indexOf(e)||(d[c].authentication||{}).all;if(h&&l&&(void 0===f.headers.Authorization||!1===isAuthorized(d[c],f)))return renderUnauthorized(d[c].authentication.namespace);void 0!==d[c].before&&"function"==typeof d[c].before&&(d.router.params=d[c].before(d.router.params));
f=void 0!==d.router.params.redirect_to?d.router.params:d[c][e](d.router.params,f);g=g||"json";f.redirect_to&&(g="redirect");g=g.match(/(html|xml|json|redirect)/i)||["json"];c=Engine[g[0]](f,d,c,e);e=["Date: "+(new Date).toGMTString(),"Content-Length: "+(c.body?c.body.length:"0")];e=e.concat(BasicHeaders).concat(c.headers).concat(d.responseHeaders.buildForHTTP());wApp.session.changed&&e.push(wApp.session.setInHeader());return c.verb+"\r\n"+e.join("\r\n")+"\r\n\r\n"+c.body}
var Engine={json:function(c,e){var d=void 0!==c.responseCode&&void 0!==c.responseCode.code&&void 0!==c.responseCode.message?"HTTP/1.0 "+c.responseCode.code+" "+c.responseCode.message:"HTTP/1.0 200 OK";delete c.responseCode;var f=e.router.params.callback;c=f?f+"("+JSON.stringify(c)+")":JSON.stringify(c);c=unescape(encodeURIComponent(c));return{verb:d,body:c,headers:["Content-Type: application/"+(f?"javascript":"json")+"; charset=utf-8"]}},html:function(c,e,d,f){if("object"==typeof c){var g=c.layout||
"application",h="/views/"+d.replace("Controller","")+"/"+f,l;c.controller=d;c.action=f;c.session=wApp.session.session;c.flash=wApp.session.flashGet;!1!==c.layout?(d=getHTML("/layouts/"+g),"template"===d.type&&(layout_temp=Handlebars.compile(d.html)),d="template"===d.type?layout_temp(c):d.html):d="#yield";h=getHTML(h);"template"===h.type&&(l=Handlebars.compile(h.html));""===h.html&&(h.html="<div><h1>There is not view for this action</h1></div>");c="template"===h.type?l(c):h.html;c=d.replace("#yield",
c)}return{verb:"HTTP/1.0 200 OK",body:e.isWindows()?c:unescape(encodeURIComponent(c)),headers:["Content-Type: text/html; charset=utf-8"]}},xml:function(c,e){return{verb:"HTTP/1.0 200 OK",body:c.xml?e.isWindows()?c.xml:unescape(encodeURIComponent(c.xml)):"<?xml version='1.0' encoding='UTF-8'?><error version='1.0'>The JSON object should have an xml key</error>",headers:["Content-Type: text/xml; charset=UTF-8"]}},redirect:function(c){return{verb:"HTTP/1.0 302 Found",body:"",headers:["location: "+c.redirect_to]}}};
function getHTML(c){importClass("VTextFile");importClass("VFile");var e=null===c.split(".")[c.split(".").length-1].match(/(css|js|html|woff|ttf|svg|eot)/i)?".html":"";c+=e;e=new VTextFile(wApp.config.root_path+c);c=new VTextFile(wApp.config.root_path+c+".hbs");var d=c.exists()?"template":"html";html=e.exists()?e.open(VFile.OpenModeReadOnly)?e.readAll():"":c.exists()?c.open(VFile.OpenModeReadOnly)?c.readAll():"":"";return{html:html,type:d}}
function logError(c){return void 0===c.lineNumber?c.message:c.message+". In Line Number: "+c.lineNumber}function renderErrorResponse(c,e){var d=wApp.router.params.callback,f={message:e},f=d?d+"("+JSON.stringify(f)+")":JSON.stringify(f),f=unescape(encodeURIComponent(f));return"HTTP/1.0 500 INTERNAL SERVER ERROR\r\n"+BasicHeaders.join("\r\n")+"\r\n\r\n"+f}
