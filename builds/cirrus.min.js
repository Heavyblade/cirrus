"use strict";function e(e,t,o){importClass("VProcess");var s=new VProcess(theRoot),a=t.fields;s.setProcess(e);var i="\r\n";delete t.body,delete t.fields;for(var p=Object.keys(t),d=p.length;d--;)p[d].toUpperCase().match(/^[A-Z0-9_]*$/)&&(t[p[d]]instanceof Date?s.setVar(p[d],t[p[d]].toISOString().split("T")[0]):s.setVar(p[d].toUpperCase(),t[p[d]]));s.exec();var c=s.varToString("RESULT"),l="Content-Type: text/html; charset=utf-8";if(""===c){var h=s.result();if(l="Content-Type: application/json",2===s.objectInfo().outputType()&&h.size()>0)c=JSON.stringify(r(h,a));else if(1===s.objectInfo().outputType()){var u=new VRegisterList(theRoot);u.setTable(h.tableInfo().idRef()),u.append(h),c=JSON.stringify(r(u,a))}}var f=["Date: "+(new Date).toGMTString(),"Content-Length: "+c.length];return"HTTP/1.0 200 OK\r\n"+(f=f.concat(n).concat([l])).join(i)+i+i+(o.isWindows()?c:unescape(encodeURIComponent(c)))}function t(e,t){importClass("VQuery");var o=new VQuery(theRoot),s=t.fields;o.setQuery(e);var a="\r\n";delete t.body,delete t.fields;for(var i=Object.keys(t),p=i.length;p--;)o.setVar(i[p].toUpperCase(),wApp.getType(t[i[p]]));if(o.exec()){var d=JSON.stringify(r(o.result(),s)),c=["Date: "+(new Date).toGMTString(),"Content-Length: "+d.length];return"HTTP/1.0 200 OK\r\n"+(c=c.concat(n).concat(["Content-Type: application/json; charset=utf-8"])).join(a)+a+a+d}}function r(e,t){var r,n=e.tableInfo(),s=n.fieldCount(),a=e.size(),i=[],p=[],d=0;if(void 0===t)for(;s--;)d=11===(r=parseInt(n.fieldType(s),10))?parseInt("11"+n.fieldObjectType(s)):r,p.push({fieldName:n.fieldId(s),fieldType:d});else for(t="string"==typeof t?t.toUpperCase().split(","):t;s--;)t.indexOf(n.fieldId(s))>-1&&(d=11===(r=parseInt(n.fieldType(s),10))?parseInt("11"+n.fieldObjectType(s)):r,p.push({fieldName:n.fieldId(s),fieldType:d}));for(s=p.length;a--;){for(var c=e.readAt(a),l=s,h={};l--;)h[p[l].fieldName]=o(p[l].fieldType,p[l].fieldName,c);i.push(h)}return i}function o(e,t,r){var o;switch(parseInt(e)){case 0:case 1:case 2:case 3:case 4:case 5:case 111:case 112:default:o=r.fieldToString(t);break;case 6:o=r.fieldToDouble(t);break;case 7:o=r.fieldToDate(t);break;case 8:case 9:o=r.fieldToDateTime(t);break;case 10:o=r.fieldToBool(t);break;case 11:case 12:case 13:case 14:case 15:case 18:o=""}return o}const n=["Server: Velneo v7","Access-Control-Allow-Origin: *","Access-Control-Allow-Headers: DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type","Access-Control-Allow-Methods: GET, POST, PUT, HEAD, OPTIONS, DELETE"];function s(e,t,r){var o="\r\n",s=unescape(encodeURIComponent(e.html)),a=["Date: "+(new Date).toGMTString(),"Content-Length: "+s.length];return e.useCache&&(a.push("Cache-Control: max-age="+e.maxAge),a.push("ETag: "+e.eTag)),"HTTP/1.0 200 OK\r\n"+(a=a.concat(n).concat(["Content-Type: "+t])).join(o)+o+o+s}wApp={version:"1.4",isWindows:function(){return theApp.sysInfo().getOsString().match(/win/i)},config:{filesTable:"cirrusdat/FILES_MEM",root_path:"D://cirrus"},router:{params:{body:{}},parse_params:function(e){for(var t=e.length;t--;){var r=e[t].split("=");this.params[r[0]]=r[1].replace(/\+/g," ")}},routes:[],rexRoutes:[],addRoutes:function(e){for(var t=Object.keys(e),r=t.length;r--;)if("resource"==t[r].split(" ")[0]){var o=this.createREST(t[r].split(" ")[1]);this.addRoutes(o)}else{var n={},s=t[r];n[s]=e[s];var a=new RegExp(s.replace(/:\w+/g,"([\\w@.]+)")+"/?$","i");this.rexRoutes.unshift(a),this.routes.unshift(n)}},createREST:function(e){var t={};return t["GET /"+e]=e+"Controller#index",t["GET /"+e+"/new"]=e+"Controller#new",t["POST /"+e]=e+"Controller#create",t["GET /"+e+"/:id"]=e+"Controller#show",t["GET /"+e+"/:id/edit"]=e+"Controller#edit",t["PUT /"+e+"/:id"]=e+"Controller#update",t["DELETE /"+e+"/:id"]=e+"Controller#delete",t},pointRequest:function(e){var t=this.rexRoutes.length;for(i=0;i<t;i++){var r=this.rexRoutes[i];if(e.match(r)){var o=this.routes[i],n=Object.keys(o)[0],s=n.match(/:(\w+)/g);if(s){var a=e.match(r);for(a.shift(),t=s.length;t--;){var p=s[t];this.params[p.replace(":","")]=decodeURIComponent(a[s.indexOf(p)])}}return o[n]}}return"NOT FOUND"}},session:{cookie_name:"v7App",cookie:{session:{}},session:{},flash:{},flashGet:{},flashSet:{},setFlash:function(e,t){return this.changed=!0,this.flashSet[e]=t,!0},getFlash:function(e){return this.flashGet[e]},changed:!1,set:function(e,t){return this.changed=!0,this.session[e]=t,!0},get:function(e){return this.session[e]},setInHeader:function(){var e,t,r="";Object.keys(this.flashSet).length>0&&(this.session.flash=this.flashSet,this.flashSet={}),0!==Object.keys(this.session).length&&(e=this.session.expires,t=this.session.path,delete this.session.expires,delete this.session.path,r=Base64.encode(encodeURIComponent(JSON.stringify(this.session))));var o=this.cookie_name+"="+r;return void 0!==e&&(o+="; expires="+e.toGMTString()),void 0!==t&&(o+="; path="+t),"set-Cookie: "+o},getFromHeader:function(e){var t=new RegExp(wApp.session.cookie_name+"=(\\w+)\\;?"),r={},o=wApp.cookie_name,n=e.match(t);return n&&(r[o]=n[1],a=Base64.decode(r[o]),b=decodeURIComponent(a),r.session=JSON.parse(b.replace(/\0/g,"")),this.cookie=r,this.session=r.session,void 0!==this.session.flash&&(this.flashGet=this.session.flash,delete this.session.flash,this.changed=!0)),r[o]}},params:function(){return this.router.params},responseHeaders:{headers:{},set:function(e,t){this.headers[e]=t},buildForHTTP:function(){var e=Object.keys(this.headers),t=e.length,r=[];for(z=0;z<t;z++)r.push(e[z]+": "+this.headers[e[z]]);return r}},request:function(e){try{var t=function(e){var t=e.split("\r\n\r\n"),r=t[0].match(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/),o=t[0].replace(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/,""),n=/(.+): (.+)/g,s=/([^&]+)=([^&]+)/g,a=r[2].split("?"),i=a[0].match(/\.(\w+)$/i),p={verb:r[1],path:r[2],protocol:r[3],url:a[0],extension:i?i[1].toLowerCase():void 0,encodeParams:a[1],decodeParams:{},headers:{},body:{},bodyDecoded:{},cookie:""};for(;header=n.exec(o);)p.headers[header[1]]=header[2];var d,c,l,h=p.encodeParams;if(p.encodeParams)for(;param=s.exec(h);)c=decodeURIComponent(param[1]).replace("[]",""),d=wApp.getType(decodeURIComponent(param[2]).replace(/\+/g," ")),void 0===(l=p.decodeParams[c])?p.decodeParams[c]=decodeURIComponent(param[1]).match(/^.*\[\]$/)?[d]:d:("object"!=typeof l&&(p.decodeParams[c]=[l]),p.decodeParams[c].push(d));if(2==t.length)for(h=p.body=t[1].trim().replace(/\+/g," ");body=s.exec(h);)if("_method"==body[1]&&decodeURIComponent(body[2]).match(/^(PUT|DELETE)$/i))p.verb=decodeURIComponent(body[2]).toUpperCase();else{var u=decodeURIComponent(body[1]).replace("[]",""),f=p.bodyDecoded[u],m=wApp.getType(decodeURIComponent(body[2]));void 0===f?p.bodyDecoded[u]=m:("object"!=typeof f&&(p.bodyDecoded[u]=[f]),p.bodyDecoded[u].push(m))}return p}(e);return wApp.router.params=t.decodeParams,void 0!==t.bodyDecoded&&(wApp.router.params.body=t.bodyDecoded),void 0!==t.headers["Content-Type"]&&t.headers["Content-Type"].match(/application\/json/i)&&t.body?wApp.router.params.body=JSON.parse(t.body):void 0!==t.headers["Content-Type"]&&t.headers["Content-Type"].match(/text\/xml/i)&&t.body?wApp.router.params.body=t.body:wApp.router.params.body=t.bodyDecoded,void 0!==t.headers.Cookie&&wApp.session.getFromHeader(t.headers.Cookie),t}catch(e){return e}},response:function(r){try{if("SyntaxError"==r.name)throw r;var o={js:"application/javascript",css:"text/css",woff:"application/font-woff",ttf:"application/font-sfnt",svg:"image/svg+xml",eot:"application/vnd.ms-fontobject"};if(void 0!==o[r.extension]){var a=d(r.url);return""!==a.html?s(a,o[r.extension],wApp):"HTTP/1.0 404 NOT FOUND"}if("pro"===r.extension){var i=wApp.router.pointRequest(r.verb+" "+r.url);return"NOT FOUND"!=i?e(i,wApp.router.params,wApp):"HTTP/1.0 404 NOT FOUND"}if("bus"===r.extension){var h=wApp.router.pointRequest(r.verb+" "+r.url);return"NOT FOUND"!=h?t(h,wApp.router.params):"HTTP/1.0 404 NOT FOUND"}if("OPTIONS"===r.verb){var u="\r\n";return"HTTP/1.0 204 OK\r\n"+["Access-Control-Allow-Origin: *","Access-Control-Allow-Headers: DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type","Access-Control-Allow-Methods: GET, POST, PUT, HEAD, OPTIONS, DELETE"].join(u)+u+u}var f=wApp.router.pointRequest(r.verb+" "+r.url.split(".")[0]);if("NOT FOUND"!=f){var m=f.split("#");return function(e,t,r,o){var s="\r\n",a=o.extension||o.headers.Accept,i=void 0!==r[e].authentication&&"object"==typeof r[e].authentication&&""!==r[e].authentication.username&&""!==r[e].authentication.password,d=((r[e].authentication||{}).actions||[]).indexOf(t)>-1||(r[e].authentication||{}).all;if(i&&d&&(void 0===o.headers.Authorization||!1===function(e,t){var r=Base64.decode(t.headers.Authorization.split(" ")[1]).split(":");return e.authentication.username==r[0]&&e.authentication.password==r[1]}(r[e],o)))return function(e){var t="\r\n",r=unescape(encodeURIComponent(JSON.stringify({message:"Unauthorized"}))),o=n.concat(['WWW-Authenticate: Basic realm="'+(e||"cirrus")+'"']),s="HTTP/1.0 401 Unauthorized"+t+o.join(t)+t+t+r;return s}(r[e].authentication.namespace);void 0!==r[e].before&&"function"==typeof r[e].before&&(r.router.params=r[e].before(r.router.params));var c=void 0!==r.router.params.redirect_to?r.router.params:r[e][t](r.router.params,o);a=a||"json",c.redirect_to&&(a="redirect");var l=a.match(/(html|xml|json|redirect)/i)||["json"],h=p[l[0]](c,r,e,t),u=["Date: "+(new Date).toGMTString(),"Content-Length: "+(h.body?h.body.length:"0")];u=u.concat(n).concat(h.headers).concat(r.responseHeaders.buildForHTTP()),wApp.session.changed&&u.push(wApp.session.setInHeader());var f=h.verb+s+u.join(s)+s+s+h.body;return f}(m[0],m[1],wApp,r)}var T=d("/views"+r.url);if(""!==T.html){var v=d("/layouts/application");return s({html:(""===v.html?"#yield":v.html).replace("#yield",T.html)},"text/html; charset=utf-8",wApp)}return"HTTP/1.0 404 NOT FOUND"}catch(e){return"SyntaxError"===e.name?l(e,"Unable to parse JSON string"):l(e,c(e))}},logError:c,getHTML:d,vRegisterListToJSON:r,renderProcess:e,renderQuery:t,mapField:o,getType:function(e){var t,r,o,n,s,a,i,p;if(e.match(/^[1-9]\d*$/i)&&e.length<14)return parseInt(e,10);if(e.match(/^\d{1,3}(\.\d{3})*(\,\d*)?$/g))return parseFloat(e.replace(/\./g,"").replace(",","."));if(e.match(/^\d{1,3}(\,\d{3})*(\.\d*)?$/g))return parseFloat(e.replace(/\,/g,""));if(e.match(/^\d*,\d*$/i))return parseFloat(e.replace(",","."));if(e.match(/^\d*\.\d*$/i))return parseFloat(e);if(e.match(/(true|false)/))return"true"==e;if(e.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}$/))return t=e.split("/"),r=e.split("-"),o=t.length>1?t:r,new Date(parseInt(o[2],10),parseInt(o[1],10)-1,parseInt(o[0],10));if(e.match(/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/))return t=e.split("/"),r=e.split("-"),o=t.length>1?t:r,new Date(parseInt(o[0],10),parseInt(o[1],10)-1,parseInt(o[2],10));if(e.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w$/)){var d=(o=e.split(" "))[0].split("/"),c=o[1].split(":"),l=o[2].match(/am/i)?parseInt(c[0]):parseInt(c[0])+12;return new Date(parseInt(d[2],10),parseInt(d[0],10)-1,parseInt(d[1],10),l,parseInt(c[1],10),parseInt(c[2],10))}if(e.match(/^\w*, \d* \w* \d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w\w$/)){return o=e.split(",")[1].split(" "),a=parseInt(o[0],10),s={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}[o[1]],n=parseInt(o[2],10),hour=parseInt(parmas[3].split(":")[0],10),i=parseInt(parmas[3].split(":")[1],10),p=parseInt(parmas[3].split(":")[2],10),new Date(n,s,a,hour,i,p)}if(e.match(/^\d{2,4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{1,2}:\d{1,2}\.\d*Z$/))return t=(o=e.split("T"))[0],r=o[1].split(".")[0],n=parseInt(t.split("-")[0],10),s=parseInt(t.split("-")[1],10)-1,a=parseInt(t.split("-")[2],10),hour=parseInt(r.split(":")[0],10),i=parseInt(r.split(":")[1],10),p=parseInt(r.split(":")[2],10),new Date(n,s,a,hour,i,p);return e}};var p={json:function(e,t){var r=void 0!==e.responseCode&&void 0!==e.responseCode.code&&void 0!==e.responseCode.message?"HTTP/1.0 "+e.responseCode.code+" "+e.responseCode.message:"HTTP/1.0 200 OK";delete e.responseCode;var o=t.router.params.callback;return e=o?o+"("+JSON.stringify(e)+")":JSON.stringify(e),{verb:r,body:e=unescape(encodeURIComponent(e)),headers:["Content-Type: application/"+(o?"javascript":"json")+"; charset=utf-8"]}},html:function(e,t,r,o){var n,s;if("object"==typeof e){var a,i=e.layout||"application",p="/views/"+r.replace("Controller","")+"/"+o;if(e.controller=r,e.action=o,e.session=wApp.session.session,e.flash=wApp.session.flashGet,!1!==e.layout){var c=d("/layouts/"+i);"template"===c.type&&(layout_temp=Handlebars.compile(c.html)),n="template"===c.type?layout_temp(e):c.html}else n="#yield";var l=d(p);"template"===l.type&&(a=Handlebars.compile(l.html)),""===l.html&&(l.html="<div><h1>There is not view for this action</h1></div>");var h="template"===l.type?a(e):l.html;s=n.replace("#yield",h)}else s=e;return{verb:"HTTP/1.0 200 OK",body:t.isWindows()?s:unescape(encodeURIComponent(s)),headers:["Content-Type: text/html; charset=utf-8"]}},xml:function(e,t){return{verb:"HTTP/1.0 200 OK",body:e.xml?t.isWindows()?e.xml:unescape(encodeURIComponent(e.xml)):"<?xml version='1.0' encoding='UTF-8'?><error version='1.0'>The JSON object should have an xml key</error>",headers:["Content-Type: text/xml; charset=UTF-8"]}},redirect:function(e){return{verb:"HTTP/1.0 302 Found",body:"",headers:["location: "+e.redirect_to]}}};function d(e){importClass("VTextFile"),importClass("VFile");var t=null===e.split(".")[e.split(".").length-1].match(/(css|js|html|woff|ttf|svg|eot)/i)?".html":"";e+=t;var r=new VTextFile(wApp.config.root_path+e),o=new VTextFile(wApp.config.root_path+e+".hbs"),n=o.exists()?"template":"html";return r.exists()?r.open(VFile.OpenModeReadOnly)?html=r.readAll():html="":o.exists()&&o.open(VFile.OpenModeReadOnly)?html=o.readAll():html="",{html:html,type:n}}function c(e){return void 0===e.lineNumber?e.message:e.message+". In Line Number: "+e.lineNumber}function l(e,t){var r="\r\n",o=wApp.router.params.callback,s={message:t};return s=o?o+"("+JSON.stringify(s)+")":JSON.stringify(s),s=unescape(encodeURIComponent(s)),"HTTP/1.0 500 INTERNAL SERVER ERROR\r\n"+n.join(r)+r+r+s}module.exports=wApp;
