function renderProcess(a,c){importClass("VProcess");var b=new VProcess(theRoot),d=c.fields;b.setProcess(a);delete c.body;delete c.fields;for(var e=Object.keys(c),f=e.length;f--;)b.setVar(e[f].toUpperCase(),wApp.getType(c[e[f]]));b.exec();e=b.varToString("RESULT");""===e&&(f=b.result(),2===b.objectInfo().outputType()&&0<f.size()?e=JSON.stringify(vRegisterListToJSON(f,d)):1===b.objectInfo().outputType()&&(b=new VRegisterList(theRoot),b.setTable(f.tableInfo().idRef()),b.append(f),e=JSON.stringify(vRegisterListToJSON(b,
d))));d=["Date: "+(new Date).toGMTString(),"Content-Length: "+e.length];d=d.concat(BasicHeaders).concat(["Content-Type: text/html; charset=utf-8"]);return"HTTP/1.0 200 OK\r\n"+d.join("\r\n")+"\r\n\r\n"+e}
function renderQuery(a,c){importClass("VQuery");var b=new VQuery(theRoot),d=c.fields;b.setQuery(a);delete c.body;delete c.fields;for(var e=Object.keys(c),f=e.length;f--;)b.setVar(e[f].toUpperCase(),wApp.getType(c[e[f]]));if(b.exec())var g=JSON.stringify(vRegisterListToJSON(b.result(),d));b=["Date: "+(new Date).toGMTString(),"Content-Length: "+g.length];b=b.concat(BasicHeaders).concat(["Content-Type: application/json; charset=utf-8"]);return"HTTP/1.0 200 OK\r\n"+b.join("\r\n")+"\r\n\r\n"+g}
function vRegisterListToJSON(a,c){var b=a.tableInfo(),d=nFields2=b.fieldCount(),e=a.size(),f=[],g=[];if(void 0===c)for(;d--;)g.push({fieldName:b.fieldId(d),fieldType:b.fieldType(d)});else for(c=c.toUpperCase().split(",");d--;)-1<c.indexOf(b.fieldId(d))&&g.push({fieldName:b.fieldId(d),fieldType:b.fieldType(d)});for(d=g.length;e--;){for(var b=a.readAt(e),h=d,k={};h--;)k[g[h].fieldName]=mapField(g[h].fieldType,g[h].fieldName,b);f.push(k)}return f}
function mapField(a,c,b){switch(parseInt(a)){case 0:a=b.fieldToString(c);break;case 1:a=b.fieldToString(c);break;case 2:a=b.fieldToString(c);break;case 3:a=b.fieldToString(c);break;case 4:a=b.fieldToString(c);break;case 5:a=b.fieldToString(c);break;case 6:a=b.fieldToDouble(c);break;case 7:a=b.fieldToDate(c);break;case 8:a=b.fieldToTime(c);break;case 9:a=b.fieldToDateTime(c);break;case 10:a=b.fieldToBool(c);break;case 11:a="";break;case 12:a="";break;case 13:a="";break;case 14:a="";break;case 15:a=
"";break;case 18:a="";break;default:a=b.fieldToString(c)}return a};wApp={version:"1.3",config:{filesTable:"cirrusdat/FILES_MEM"},router:{params:{body:{}},parse_params:function(a){for(var c=a.length;c--;){var b=a[c].split("=");this.params[b[0]]=b[1].replace(/\+/g," ")}},routes:[],rexRoutes:[],addRoutes:function(a,c){if(0===Object.keys(this.routes).length||"rest"==c)for(var b=Object.keys(a),d=b.length;d--;)if("resource"==b[d].split(" ")[0]){var e=this.createREST(b[d].split(" ")[1]);this.addRoutes(e,"rest")}else{var e={},f=b[d];e[f]=a[f];f=RegExp(f.replace(/:\w+/g,
"([\\w@.]+)")+"/?$","i");this.rexRoutes.unshift(f);this.routes.unshift(e)}},createREST:function(a){var c={};c["GET /"+a]=a+"Controller#index";c["GET /"+a+"/new"]=a+"Controller#new";c["POST /"+a]=a+"Controller#create";c["GET /"+a+"/:id"]=a+"Controller#show";c["GET /"+a+"/:id/edit"]=a+"Controller#edit";c["PUT /"+a+"/:id"]=a+"Controller#update";c["DELETE /"+a+"/:id"]=a+"Controller#delete";return c},pointRequest:function(a){var c=this.rexRoutes.length;for(i=0;i<c;i++){var b=this.rexRoutes[i];if(a.match(b)){var d=
this.routes[i],e=Object.keys(d)[0],f=e.match(/:(\w+)/g);if(f)for(a=a.match(b),a.shift(),c=f.length;c--;)b=f[c],this.params[b.replace(":","")]=decodeURIComponent(a[f.indexOf(b)]);return d[e]}}return"NOT FOUND"}},session:{cookie_name:"v7App",cookie:{session:{}},session:{},flash:{},changed:!1,set:function(a,c){this.changed=!0;this.session[a]=c;return!0},get:function(a){return this.session[a]},setInHeader:function(){var a,c,b="";0<Object.keys(this.flash).length&&(this.session.flash=this.flash);0!==Object.keys(this.session).length&&
(a=this.session.expires,c=this.session.path,delete this.session.expires,delete this.session.path,b=Base64.encode(encodeURIComponent(JSON.stringify(this.session))));b=this.cookie_name+"="+b;void 0!==a&&(b+="; expires="+a.toGMTString());void 0!==c&&(b+="; path="+c);return"set-Cookie: "+b},getFromHeader:function(a){var c={},b=wApp.cookie_name;if(a=a.match(RegExp(wApp.session.cookie_name+"=(\\w+)\\;?")))c[b]=a[1],c.session=JSON.parse(decodeURIComponent(Base64.decode(c[b]))),this.cookie=c,this.session=
c.session;return c[b]}},params:function(){return this.router.params},request:Request,response:Response,logError:logError,getHTML:getHTML,vRegisterListToJSON:vRegisterListToJSON,renderProcess:renderProcess,renderQuery:renderQuery,mapField:mapField,getType:getType};
function http_parser(a,c){for(var b=a.split("\r\n\r\n"),d=b[0].match(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/),e=b[0].replace(/^(GET|POST|PUT|DELETE|UPDATE|OPTIONS) (.+) (.+)[\r\n]?/,""),f=/(.+): (.+)/g,g=/([^&]+)=([^&]+)/g,h=d[2].split("?"),k=h[0].match(/\.(\w+)$/i),d={verb:d[1],path:d[2],protocol:d[3],url:h[0],extension:k?k[1].toLowerCase():void 0,encodeParams:h[1],decodeParams:{},headers:{},body:{},bodyDecoded:{},cookie:""};header=f.exec(e);)d.headers[header[1]]=header[2];if(e=
d.encodeParams)for(;param=g.exec(e);)d.decodeParams[param[1]]=wApp.getType(decodeURIComponent(param[2]).replace(/\+/g," "));if(2==b.length)for(e=d.body=b[1].trim().replace(/\+/g," ");body=g.exec(e);)d.bodyDecoded[body[1]]=wApp.getType(decodeURIComponent(body[2]));return d}
function Request(a){try{var c=http_parser(a);wApp.router.params=c.decodeParams;wApp.router.params.body="application/json"===c.headers["Content-Type"]&&c.body?JSON.parse(c.body):"text/xml"===c.headers["Content-Type"]&&c.body?c.body:c.bodyDecoded;void 0!==c.headers.Cookie&&wApp.session.getFromHeader(c.headers.Cookie);return c}catch(b){return b}}
function getType(a){if(a.match(/^[1-9]\d*$/i))return parseInt(a,10);if(a.match(/^\d{1,3}(\.\d{3})*(\,\d*)?$/g))return parseFloat(a.replace(/\./g,"").replace(",","."));if(a.match(/^\d{1,3}(\,\d{3})*(\.\d*)?$/g))return parseFloat(a.replace(/\,/g,""));if(a.match(/^\d*,\d*$/i))return parseFloat(a.replace(",","."));if(a.match(/^\d*\.\d*$/i))return parseFloat(a);if(a.match(/(true|false)/))return"true"==a?!0:!1;if(a.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4}$/)){var c=a.split("/"),b=a.split("-"),d=1<c.length?
c:b;return a=new Date(parseInt(d[2]),parseInt(d[1])-1,parseInt(d[0]))}if(a.match(/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/))return c=a.split("/"),b=a.split("-"),d=1<c.length?c:b,a=new Date(parseInt(d[0]),parseInt(d[1])-1,parseInt(d[2]));if(a.match(/^\d{1,2}[\/-]\d{1,2}[\/-]\d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w$/))return d=a.split(" "),a=d[0].split("/"),c=d[1].split(":"),d=d[2].match(/am/i)?parseInt(c[0]):parseInt(c[0])+12,a=new Date(parseInt(a[2]),parseInt(a[0])-1,parseInt(a[1]),d,parseInt(c[1]),parseInt(c[2]));
if(a.match(/^\w*, \d* \w* \d{2,4} \d{1,2}:\d{1,2}:\d{1,2} \w\w\w$/)){d=a.split(",")[1].split(" ");c=parseInt(d[0]);a={Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12}[d[1]];var d=parseInt(d[2]),e=parseInt(parmas[3].split(":")[0]),f=parseInt(parmas[3].split(":")[1]),b=parseInt(parmas[3].split(":")[2]);return a=new Date(d,a,c,e,f,b)}a.match(/^\d{2,4}-\d{1,2}-\d{1,2}T\d{1,2}:\d{1,2}:\d{1,2}\.\d*Z$/)&&(d=a.split("T"),c=d[0],b=d[1].split(".")[0],d=parseInt(c.split("-")[0]),a=
parseInt(c.split("-")[1])-1,c=parseInt(c.split("-")[2]),e=parseInt(b.split(":")[0]),f=parseInt(b.split(":")[1]),b=parseInt(b.split(":")[2]),a=new Date(d,a,c,e,f,b));return a}var BasicHeaders=["Server: Velneo v7","transfer-coding: chunked","Keep-Alive: timeout=5, max=94","Connection: Keep-Alive"];function isAsset(a){return"js"===a.extension||"css"===a.extension}
function Response(a){try{if("SyntaxError"==a.name)throw a;if("js"===a.extension||"css"===a.extension){var c=getHTML(a.url).html;if(""!==c){var b="css"===a.url.substr(a.url.length-3)?"text/css":"application/javascript";return renderResponseAssets(c,b)}return"HTTP/1.0 404 NOT FOUND"}if("pro"===a.extension){var d=wApp.router.pointRequest(a.verb+" "+a.url);return"NOT FOUND"!=d?renderProcess(d,wApp.router.params):"HTTP/1.0 404 NOT FOUND"}if("bus"===a.extension){var e=wApp.router.pointRequest(a.verb+" "+
a.url);return"NOT FOUND"!=e?renderQuery(e,wApp.router.params):"HTTP/1.0 404 NOT FOUND"}if("OPTIONS"===a.verb)return"HTTP/1.0 204 OK\r\nAccess-Control-Allow-Origin: *\r\nAccess-Control-Allow-Headers: DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type\r\nAccess-Control-Allow-Methods: GET, POST, PUT, HEAD, OPTIONS, DELETE\r\n\r\n";var f=wApp.router.pointRequest(a.verb+" "+a.url.split(".")[0]);if("NOT FOUND"!=f){var g=f.split("#");return renderResponse(g[0],
g[1],wApp,a.extension||a.headers.Accept)}return"HTTP/1.0 404 NOT FOUND"}catch(h){switch(h.name){case "SyntaxError":return renderErrorResponse(h,"Unable to parse JSON string");default:return a=logError(h),renderErrorResponse(h,a)}}}function renderResponseAssets(a,c){var b=["Date: "+(new Date).toGMTString(),"Content-Length: "+a.length],b=b.concat(BasicHeaders).concat(["Content-Type: "+c]);return"HTTP/1.0 200 OK\r\n"+b.join("\r\n")+"\r\n\r\n"+a}
function renderResponse(a,c,b,d){void 0!==b[a].before&&(b.router.params=b[a].before(b.router.params));var e=void 0!==b.router.params.redirect_to?b.router.params:b[a][c](b.router.params);d=d||"json";e.redirect_to&&(d="redirect");d=d.match(/(html|xml|json|redirect)/i)||["json"];a=Engine[d[0]](e,b,a,c);c=["Date: "+(new Date).toGMTString(),"Content-Length: "+(a.body?a.body.length:"0")];c=c.concat(BasicHeaders).concat(a.headers);wApp.session.changed&&c.push(wApp.session.setInHeader());return a.verb+"\r\n"+
c.join("\r\n")+"\r\n\r\n"+a.body}
var Engine={json:function(a,c){var b=void 0!==a.responseCode&&void 0!==a.responseCode.code&&void 0!==a.responseCode.message?"HTTP/1.0 "+a.responseCode.code+" "+a.responseCode.message:"HTTP/1.0 200 OK";delete a.responseCode;var d=c.router.params.callback;a=d?d+"("+JSON.stringify(a)+")":JSON.stringify(a);a=unescape(encodeURIComponent(a));return{verb:b,body:a,headers:["Content-Type: application/"+(d?"javascript":"json")+"; charset=utf-8"]}},html:function(a,c,b,d){if("object"==typeof a){var e=a.layout||
"application";c="/views/"+b.replace("Controller","")+"/"+d;a.controller=b;a.action=d;!1!==a.layout?(b=getHTML("/layouts/"+e),"template"===b.type&&eval("layout_temp = "+b.template),a.session=wApp.session.session,b="template"===b.type?Handlebars.VM.template(layout_temp)(a):b.html):b="#yield";c=getHTML(c);"template"===c.type&&eval("template = "+c.template);a="template"===c.type?Handlebars.VM.template(template)(a):c.html;a=b.replace("#yield",a)}return{verb:"HTTP/1.0 200 OK",body:unescape(encodeURIComponent(a)),
headers:["Content-Type: text/html; charset=utf-8"]}},xml:function(a){return{verb:"HTTP/1.0 200 OK",body:a.xml?unescape(encodeURIComponent(a.xml)):"<?xml version='1.0' encoding='UTF-8'?><error version='1.0'>The JSON object should have an xml key</error>",headers:["Content-Type: text/xml; charset=UTF-8"]}},redirect:function(a){return{verb:"HTTP/1.0 302 Found",body:"",headers:["location: "+a.redirect_to]}}};
function getHTML(a){var c=new VRegisterList(theRoot);c.setTable(wApp.config.filesTable);c.load("PATH",[a]);if(0<c.listSize()){var b=c.readAt(0);a=b.fieldToString("BODY");c="1"==b.fieldToString("TIPO")?"html":"template";b=b.fieldToString("COMPILED")}else a="<div><h1>There is not view for this action</h1></div>",b="",c="html";return{html:a,type:c,template:b}}function logError(a){return void 0===a.lineNumber?a.message:a.message+". In Line Number: "+a.lineNumber}
function renderErrorResponse(a,c){var b=wApp.router.params.callback,d={message:c},d=b?b+"("+JSON.stringify(d)+")":JSON.stringify(d),d=unescape(encodeURIComponent(d));return"HTTP/1.0 500 INTERNAL SERVER ERROR\r\n"+BasicHeaders.join("\r\n")+"\r\n\r\n"+d}
