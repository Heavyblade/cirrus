/*! cirrus 1.0.1 2013-03-16 */
function StringBuffer(){this.buffer=[]}function Utf8EncodeEnumerator(e){this._input=e,this._index=-1,this._buffer=[]}function Base64DecodeEnumerator(e){this._input=e,this._index=-1,this._buffer=[]}function http_parser(e){for(var r=e.split("\r\n\r\n"),t=r[0].match(/^(GET|POST|PUT|DELETE|UPDATE) (.+) (.+)[\r\n]?/),n=r[0].replace(/^(GET|POST|PUT|DELETE|UPDATE) (.+) (.+)[\r\n]?/,""),o=/(.+): (.+)/g,s=/([^&]+)=([^&]+)/g,i=t[2].split("?"),a={verb:t[1],path:t[2],protocol:t[3],url:i[0],encodeParams:i[1],decodeParams:{},headers:{},body:{},bodyDecoded:{},cookie:""};header=o.exec(n);)a.headers[header[1]]=header[2];var u=decodeURIComponent(a.encodeParams).replace(/\+/g," ");if(a.encodeParams)for(;param=s.exec(u);)a.decodeParams[param[1]]=param[2];if(2==r.length)for(u=a.body=decodeURIComponent(r[1].trim().replace(/\+/g," "));body=s.exec(u);)a.bodyDecoded[body[1]]=body[2];return a}function Request(e){var r=http_parser(e);return wApp.router.params=r.decodeParams,wApp.router.params.body=r.bodyDecoded,void 0!==r.headers.Cookie&&wApp.getSession(r.headers.Cookie),r}function Response(e){try{var r=wApp.router.pointRequest(e.verb+" "+e.url);if("NOT FOUND"!=r){var t=r.split("#");return renderResponse(t[0],t[1],wApp)}return"HTTP/1.0 404 NOT FOUND"}catch(n){var o=logError(n);return renderErrorResponse(n,o)}}function renderResponse(e,r,t){var n="\r\n",o=t[e][r](t.router.params),s=t.router.params.callback;o=s?s+"("+JSON.stringify(o)+")":JSON.stringify(o),o=unescape(encodeURIComponent(o));var i=["Date: "+(new Date).toGMTString(),"Content-Type: application/"+(s?"javascript":"json")+"; charset=utf-8","Content-Length: "+o.length,"Server: Velneo v7","transfer-coding: chunked","Keep-Alive: timeout=5, max=94","Connection: Keep-Alive"],a="HTTP/1.1 200 OK";t.sessionChanged&&i.push(t.setSession());var u=a+n+i.join(n)+n+n+o;return u}function logError(e){var r=void 0===e.lineNumber?e.message:e.message+". In Line Number: "+e.lineNumber;return r}function renderErrorResponse(e,r){var t="\r\n",n=wApp.router.params.callback,o={message:r};o=n?n+"("+JSON.stringify(o)+")":JSON.stringify(o),o=unescape(encodeURIComponent(o));var s="HTTP/1.O 500  INTERNAL SERVER ERROR"+t+BasicHeaders.join(t)+t+t+o;return s}StringBuffer.prototype.append=function(e){return this.buffer.push(e),this},StringBuffer.prototype.toString=function(){return this.buffer.join("")};var Base64={codex:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){for(var r=new StringBuffer,e=new Utf8EncodeEnumerator(e);e.moveNext();){var t=e.current;e.moveNext();var n=e.current;e.moveNext();var o=e.current,s=t>>2,t=(3&t)<<4|n>>4,i=(15&n)<<2|o>>6,a=63&o;isNaN(n)?i=a=64:isNaN(o)&&(a=64),r.append(this.codex.charAt(s)+this.codex.charAt(t)+this.codex.charAt(i)+this.codex.charAt(a))}return""+r},decode:function(e){for(var r=new StringBuffer,e=new Base64DecodeEnumerator(e);e.moveNext();){var t=e.current;if(128>t)r.append(String.fromCharCode(t));else if(t>191&&224>t){e.moveNext();var n=e.current;r.append(String.fromCharCode((31&t)<<6|63&n))}else e.moveNext(),n=e.current,e.moveNext(),r.append(String.fromCharCode((15&t)<<12|(63&n)<<6|63&e.current))}return""+r}};Utf8EncodeEnumerator.prototype={current:Number.NaN,moveNext:function(){if(this._buffer.length>0)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=Number.NaN,!1;var e=this._input.charCodeAt(++this._index);return 13==e&&10==this._input.charCodeAt(this._index+1)&&(e=10,this._index+=2),128>e?this.current=e:(e>127&&2048>e?this.current=192|e>>6:(this.current=224|e>>12,this._buffer.push(128|63&e>>6)),this._buffer.push(128|63&e)),!0}},Base64DecodeEnumerator.prototype={current:64,moveNext:function(){if(this._buffer.length>0)return this.current=this._buffer.shift(),!0;if(this._index>=this._input.length-1)return this.current=64,!1;var e=Base64.codex.indexOf(this._input.charAt(++this._index)),r=Base64.codex.indexOf(this._input.charAt(++this._index)),t=Base64.codex.indexOf(this._input.charAt(++this._index)),n=Base64.codex.indexOf(this._input.charAt(++this._index)),o=(3&t)<<6|n;return this.current=e<<2|r>>4,64!=t&&this._buffer.push((15&r)<<4|t>>2),64!=n&&this._buffer.push(o),!0}},module.exports=Base64,wApp={router:{params:{body:{}},parse_params:function(e){for(var r=e.length;r--;){var t=e[r].split("=");this.params[t[0]]=t[1].replace(/\+/g," ")}},routes:{},addRoutes:function(e){for(var r=Object.keys(e),t=r.length;t--;)if("resource"==r[t].split(" ")[0]){var n=this.createREST(r[t].split(" ")[1]);this.addRoutes(n)}else{var o={},s=r[t];o[s]=e[s],this.routes[s.replace(/:\w+/g,"(\\w+)")]=o}},createREST:function(e){var r={};return r["GET /"+e]=e+"Controller#index",r["GET /"+e+"/new"]=e+"Controller#new",r["POST /"+e]=e+"Controller#create",r["GET /"+e+"/:id"]=e+"Controller#show",r["GET /"+e+"/:id/edit"]=e+"Controller#edit",r["PUT /"+e+"/:id"]=e+"Controller#update",r["DELETE /"+e+"/:id"]=e+"Controller#delete",r},pointRequest:function(e){keys=Object.keys(this.routes);for(var r=keys.length;r--;){var t=RegExp(keys[r].replace(/\//g,"\\/")+"$"),n=e.match(t);if(n){var o=this.routes[keys[r]],s=Object.keys(o)[0],i=s.match(/:(\w+)/g);if(i){var a=e.match(t);a.shift();for(var u=i.length;u--;){var c=i[u];this.params[c.replace(":","")]=a[i.indexOf(c)]}}return o[s]}}return"NOT FOUND"}},cookie_name:"v7App",cookie:{session:{}},session:{},oldcookie:{session:{}},sessionChanged:!1,setInSession:function(e,r){this.sessionChanged=!0,wApp.session[e]=r},setSession:function(){var e,r;0!==Object.keys(this.session).length&&(e=this.session.expires,r=this.session.path,delete this.session.expires,delete this.session.path,encoded=Base64.encode(encodeURIComponent(JSON.stringify(this.session))));var t=this.cookie_name+"="+encoded;return void 0!==e&&(t+="; expires="+e.toGMTString()),void 0!==r&&(t+="; path="+r),"set-Cookie: "+t},getSession:function(e){var r=RegExp(wApp.cookie_name+"=(\\w+)\\;?"),t={},n=wApp.cookie_name,o=e.match(r);return o&&(t[n]=o[1],t.session=JSON.parse(decodeURIComponent(Base64.decode(t[n]))),this.cookie=t,this.session=t.session),t[n]},params:function(){return this.router.params},request:Request,response:Response,logError:logError};var BasicHeaders=["Server: Velneo v7","transfer-coding: chunked","Keep-Alive: timeout=5, max=94","Connection: Keep-Alive"];module.exports=wApp;