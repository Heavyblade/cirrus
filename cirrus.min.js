/*! cirrus 1.0.1 2013-03-16 */
function http_parser(e){for(var r=e.split("\r\n\r\n"),o=r[0].match(/^(GET|POST|PUT|DELETE|UPDATE) (.+) (.+)[\r\n]?/),s=r[0].replace(/^(GET|POST|PUT|DELETE|UPDATE) (.+) (.+)[\r\n]?/,""),n=/(.+): (.+)/g,t=/([^&]+)=([^&]+)/g,a=o[2].split("?"),i={verb:o[1],path:o[2],protocol:o[3],url:a[0],encodeParams:a[1],decodeParams:{},headers:{},body:{},bodyDecoded:{},cookie:""};header=n.exec(s);)i.headers[header[1]]=header[2];var p=decodeURIComponent(i.encodeParams).replace(/\+/g," ");if(i.encodeParams)for(;param=t.exec(p);)i.decodeParams[param[1]]=param[2];if(2==r.length)for(p=i.body=decodeURIComponent(r[1].trim().replace(/\+/g," "));body=t.exec(p);)i.bodyDecoded[body[1]]=body[2];return i}function Request(e){var r=http_parser(e);return wApp.router.params=r.decodeParams,wApp.router.params.body=r.bodyDecoded,void 0!=r.headers.Cookie&&wApp.getSession(r.headers.Cookie),r}function Response(e){try{var r=wApp.router.pointRequest(e.verb+" "+e.url);if("NOT FOUND"!=r)var o=r.split("#"),s=renderResponse(o[0],o[1],wApp);else var s="HTTP/1.0 404 NOT FOUND";return s}catch(n){var t=logError(n);return renderErrorResponse(n,t)}}function renderResponse(e,r,o){var s="\r\n",n=o[e][r](o.router.params),t=o.router.params.callback,n=t?t+"("+JSON.stringify(n)+")":JSON.stringify(n);n=unescape(encodeURIComponent(n));var a=["Date: "+(new Date).toGMTString(),"Content-Type: application/"+(t?"javascript":"json")+"; charset=utf-8","Content-Length: "+n.length,"Server: Velneo v7","transfer-coding: chunked","Keep-Alive: timeout=5, max=94","Connection: Keep-Alive"],i="HTTP/1.1 200 OK";o.sessionChanged&&a.push(o.setSession());var p=i+s+a.join(s)+s+s+n;return p}function logError(e){var r=void 0==e.lineNumber?e.message:e.message+". In Line Number: "+e.lineNumber;return r}function renderErrorResponse(e,r){var o="\r\n",s=wApp.router.params.callback,n={message:r},n=s?s+"("+JSON.stringify(n)+")":JSON.stringify(n);n=unescape(encodeURIComponent(n));var t="HTTP/1.O 500  INTERNAL SERVER ERROR"+o+BasicHeaders.join(o)+o+o+n;return t}Base64=require("./base64.js"),wApp={router:{params:{body:{}},parse_params:function(e){for(var r=e.length;r--;){var o=e[r].split("=");this.params[o[0]]=o[1].replace(/\+/g," ")}},routes:{},addRoutes:function(e){for(var r=Object.keys(e),o=r.length;o--;)if("resource"==r[o].split(" ")[0]){var s=this.createREST(r[o].split(" ")[1]);this.addRoutes(s)}else{var n={},t=r[o];n[t]=e[t],this.routes[t.replace(/:\w+/g,"(\\w+)")]=n}},createREST:function(e){var r={};return r["GET /"+e]=e+"Controller#index",r["GET /"+e+"/new"]=e+"Controller#new",r["POST /"+e]=e+"Controller#create",r["GET /"+e+"/:id"]=e+"Controller#show",r["GET /"+e+"/:id/edit"]=e+"Controller#edit",r["PUT /"+e+"/:id"]=e+"Controller#update",r["DELETE /"+e+"/:id"]=e+"Controller#delete",r},pointRequest:function(e){keys=Object.keys(this.routes);for(var r=keys.length;r--;){var o=RegExp(keys[r].replace(/\//g,"\\/")+"$"),s=e.match(o);if(s){var n=this.routes[keys[r]],t=Object.keys(n)[0],a=t.match(/:(\w+)/g);if(a){var i=e.match(o);i.shift();for(var p=a.length;p--;){var c=a[p];this.params[c.replace(":","")]=i[a.indexOf(c)]}}return n[t]}}return"NOT FOUND"}},cookie_name:"v7App",cookie:{session:{}},session:{},oldcookie:{session:{}},sessionChanged:!1,setInSession:function(e,r){this.sessionChanged=!0,wApp.session[e]=r},setSession:function(){var e,r;0!==Object.keys(this.session).length&&(e=this.session.expires,r=this.session.path,delete this.session.expires,delete this.session.path,encoded=Base64.encode(encodeURIComponent(JSON.stringify(this.session))));var o=this.cookie_name+"="+encoded;return void 0!==e&&(o+="; expires="+e.toGMTString()),void 0!==r&&(o+="; path="+r),"set-Cookie: "+o},getSession:function(e){var r=RegExp(wApp.cookie_name+"=(\\w+)\\;?"),o={},s=wApp.cookie_name,n=e.match(r);return n&&(o[s]=n[1],o.session=JSON.parse(decodeURIComponent(Base64.decode(o[s]))),this.cookie=o,this.session=o.session),o[s]},params:function(){return this.router.params},request:Request,response:Response,logError:logError};var BasicHeaders=["Server: Velneo v7","transfer-coding: chunked","Keep-Alive: timeout=5, max=94","Connection: Keep-Alive"];module.exports=wApp;